#include "gtest/gtest.h"
#include "gmock/gmock.h"
#include <chrono>
#include <iostream>

#include "superpositeur/Circuit.hpp"
#include "superpositeur/DefaultOperations.hpp"

namespace superpositeur {

using namespace std::complex_literals;

using testing::ElementsAreArray;
using testing::DoubleNear;

namespace {
Circuit randomCircuit() {

    Circuit c;
    c.addInstruction(CircuitInstruction({ Matrix({ { -0.06577520642473456 + 0.021927569677081146i, 0.0446854978697783 + -0.04634499383667189i, 0.023283825553655206 + 0.003694428790109047i, -0.0363175893587218 + -0.10247573787039073i }, { -0.012847981476783416 + -0.10153428294012788i, -0.008075491234956815 + -0.12613863654163307i, 0.12426154241886109 + -0.08663638874569331i, 0.13421503513928057 + 0.0023284744625296588i }, { 0.17582631277833805 + -0.01707990972822694i, -0.04308159762412858 + -0.12907894917848015i, -0.010235587868411741 + -0.015144200078071116i, -0.15151228882814463 + -0.03656291603519317i }, { 0.03310968297188182 + -0.10762990090407315i, -0.016509151153901395 + -0.029900237451956142i, -0.02914331850048789 + 0.09013132075356013i, 0.015589455838487382 + 0.10268960874414398i } }), Matrix({ { 0.24752644340237667 + -0.046135781931684966i, 0.1176393408410055 + 0.04077567815961507i, 0.056870428276439816 + -0.13324926147621066i, 0.06712482377078308 + 0.04010447010091727i }, { -0.17929774837850634 + -0.05239281004779106i, -0.009015172384966304 + 0.19177263316003054i, 0.014037231916304344 + 0.04094025425510716i, -0.06358267087781104 + -0.22534021963577605i }, { 0.0030332318032241477 + 0.19141296011862396i, 0.03965924738229597 + 0.1724283398364458i, -0.032281578041471845 + -0.05674870322255959i, 0.050670884809133634 + -0.05987995099553979i }, { 0.06954323486855904 + 0.06320485262830343i, -0.04311150544272616 + -0.09550349163312369i, 0.0695381871327462 + 0.09024858811236017i, -0.15106339419045905 + 0.046429649966006833i } }), Matrix({ { 0.10280248492129672 + 0.12432909898268274i, -0.01736604548687328 + -0.07907579662018283i, -0.06641853879831827 + -0.15283050438786355i, 0.08595166729001702 + -0.1564936015342723i }, { -0.09708122010854027 + -0.06991626040833702i, 0.19003954917451 + 0.028560183081117452i, 0.07324193648200895 + -0.05879382082580754i, -0.0410875896685308 + -0.1260345076444909i }, { -0.06073554038259849 + 0.11751673782388053i, -0.12059713209088237 + -0.04644797603134912i, -0.0978919474002079 + -0.10102688870956379i, -0.02868261795986701 + 0.07290456596243654i }, { -0.08835157488295972 + 0.052233465316176717i, 0.08625900871796632 + 0.16681690461146492i, -0.17187171550164015 + 0.2056379142120486i, -0.04562986229065767 + 0.06215332390598917i } }), Matrix({ { 0.03649921227697764 + 0.0447747963703473i, 0.12758887018824697 + 0.09826104967047765i, -0.002974120181728271 + 0.08067195701815617i, 0.04879769686517581 + 0.0739662971696882i }, { 0.18694317780599437 + -0.02762893946822998i, 0.12610167574428355 + 0.14107821756290242i, -0.16018613944551968 + -0.012994192489950224i, 0.0037983081946461605 + -0.026377103475052767i }, { 0.10420769841613717 + 0.13198449948539287i, 0.06614227741123865 + -0.10498537221879543i, 0.13024785601140493 + 0.12780903041661987i, -0.01794109754181387 + -0.12171512368474252i }, { 0.038738298991899574 + 0.05500427592612633i, -0.13076537424300574 + -0.1460660076061204i, 0.04558032264275051 + -0.07730375862078662i, -0.1405945925342171 + -0.10652304715060636i } }), Matrix({ { -0.013240060251131835 + -0.018845799257437183i, -0.024943812789954115 + 0.08012499832554207i, 0.015729458461150515 + -0.08095038575314517i, -0.10730765281406196 + -0.017059826755652995i }, { -0.1803574264238122 + -0.0071919425260212975i, -0.13092019391529086 + -0.13780759023597958i, 0.03283205357798721 + 0.027156876944519896i, 0.10117220671426222 + -0.07195050991178499i }, { -0.0546717972209154 + 0.05209699252277757i, -0.04277733735846813 + -0.06304566965613953i, -0.03470473955715746 + 0.06541949855522719i, 0.06796904476504104 + -0.0459377223241948i }, { 0.044334243194876236 + 0.01987538069864944i, 0.003440782827403456 + 0.07294821250935646i, 0.030208828956370302 + -0.04166313653075791i, -0.030796420402946882 + -0.012768839270387541i } }), Matrix({ { -0.04559934416274187 + 0.015229281576857137i, 0.18353347582946847 + 0.006812095802364995i, 0.04918205781594143 + 0.008425316326672762i, -0.0020851670215623424 + -0.012175084091250047i }, { 0.0408538154983825 + -0.08873825684745787i, 0.03567152783930159 + -0.049909810452109724i, -0.04198283278354026 + -0.1028122398359186i, 0.018599379944365047 + 0.10234800772762005i }, { 0.04512875761335184 + -0.09223793421300745i, 0.07061800428800058 + 0.18001926684046263i, -0.12116271836249025 + 0.010215590704775497i, 0.17329837076601362 + 0.045312041195940046i }, { -0.17233304716244258 + 0.2017232077281473i, -0.061937932523203516 + -0.024304220883998744i, -0.04060434619634356 + 0.019724635541890585i, -0.12027732004515632 + 0.09852950875846812i } }), Matrix({ { 0.11686258922721175 + 0.13092257952896846i, -0.024466121023062698 + -0.032357629391803866i, -0.2029513555416913 + 0.02426028135888878i, 0.03366817038337221 + -0.10060210743039062i }, { 0.0023279175509845866 + -0.11561966285625884i, -0.03945935657875883 + -0.07005613098717117i, -0.06381456888171962 + 0.09046576963597772i, 0.03480107327662359 + 0.02091893721632572i }, { -0.0017545053665398054 + -0.018496970577751605i, 0.020407109346461564 + 0.11007133493721111i, 0.0015329359041474412 + 0.1751580563666288i, 0.09195129961148257 + -0.055434594342161365i }, { -0.018346830646464685 + 0.08390701614643205i, -0.0023983961447260984 + -0.08452980946791482i, -0.13119122070313644 + 0.025060461142826763i, -0.15924981288626536 + -0.10002258949146975i } }), Matrix({ { -0.03888002881194513 + -0.019367441748514957i, 0.13637525877329823 + 0.08486073298703485i, -0.04765455097964848 + -0.07400474486738674i, -0.05337253087964922 + 0.0727308390152293i }, { -0.050560538189288545 + -0.005254961477111892i, -0.03183735452685337 + -0.04716479193478149i, -0.09957069165572704 + 0.2009023284173343i, -0.08997008952940648 + -0.09307599196520525i }, { 0.14803730885581054 + 0.0032432642192784236i, 0.051486861224569094 + 0.1224035025670242i, 0.12841488656605943 + -0.13364400459490441i, -0.03824904095261804 + -0.0033805203850916215i }, { -0.14424604742983696 + -0.159351408658801i, 0.016506960652594136 + 0.03844716415239701i, -0.07068118763803759 + 0.058267108485320004i, -0.11052921629565175 + 0.02916906294722154i } }), Matrix({ { -0.12851217309856824 + -0.0754562814427924i, 0.018520270212567597 + -0.03552758783439969i, 0.029063634740582267 + 0.13513733487930868i, -0.010228361540196271 + -0.11415456918330684i }, { 0.03224653348941511 + 0.046448930312130106i, 0.021111334537509692 + -0.011993407895248925i, 0.060937042559477884 + -0.15147466086167i, 0.06185549227370483 + 0.056665425851482515i }, { 0.21218915544310357 + -0.05366469681592837i, -0.09478858713176518 + -0.033614724749561835i, 0.07168325046938666 + 0.003983219262117045i, -0.043789233999208914 + 0.05738861202123347i }, { -0.05203906124219279 + 0.004176142760018363i, 0.0068550582319498584 + 0.07049825591449117i, 0.09430435329132357 + -0.15917970410678403i, -0.0194607654005256 + -0.019252110807154315i } }), Matrix({ { 0.10286594122373037 + 0.0005075247581233311i, -0.02690078594162897 + -0.0931851613236191i, -0.12782790427403248 + 0.11037229314103995i, 0.005738306272797847 + -0.032817863090727i }, { -0.010669729719770224 + -0.06090798235747915i, -0.1388339161011711 + 0.061688553274054585i, 0.11803106452295377 + 0.07326562646146473i, -0.021008980131722775 + 0.043591387149925234i }, { -0.06116610280493151 + -0.06738380465268438i, -0.08453766158293029 + -0.04411794771039827i, -0.03221558293534897 + -0.003931110160112253i, -0.05961960082529301 + 0.07477063216143835i }, { -0.09967020331866493 + -0.12661704315797398i, 0.02339202299670445 + -0.031891004685652286i, 0.01553612815518358 + 0.05231246038050565i, 0.09947240533564491 + -0.029089994127713445i } }), Matrix({ { -0.07252439102796741 + -0.07368446826818549i, -0.03222493835908495 + 0.07507063119152797i, 0.03461930202780743 + 0.08776163321375595i, 0.12656022232896322 + -0.0795462939974042i }, { 0.05508615662422853 + -0.008071062699343214i, -0.19666005177679435 + -0.1559775037850003i, 0.007900424008045508 + -0.01801362560416397i, 0.3055080186572283 + -0.08528817912641376i }, { 0.027783277533088544 + 0.07693739568174779i, 0.04704665924219934 + 0.056508475144678966i, 0.036623224404539384 + -0.06767806499569104i, 0.18861065966949167 + 0.0890411174915063i }, { 0.11812328642339509 + 0.05622433301617378i, -0.059716079197712414 + 0.133799874186703i, 0.12214777470654838 + 0.0945859162743749i, 0.11936988312160293 + -0.196242552106951i } }), Matrix({ { 0.021677628483399724 + -0.012240763294774776i, -0.10978960311943319 + 0.02971339656821496i, 0.06179266578235866 + 0.18601197153634352i, -0.048997388417021434 + -0.016462940682653682i }, { 0.10125335532606747 + 0.06130128301661507i, -0.1987534531616909 + -0.04067896035076653i, -0.06690283963129144 + 0.020709241172941952i, 0.10239723616745679 + -0.08585742967164774i }, { 0.01249320831941682 + -0.037774420332452846i, 0.03131224674208339 + -0.0005338549153727468i, -0.12390420354931572 + -0.135668664795667i, -0.05067384194115688 + -0.0468797041444313i }, { -0.03172801028136677 + -0.02140484468922789i, 0.09929658951917844 + -0.09981214890598192i, -0.0700511427210574 + -0.048383844077718945i, -0.04309216194859122 + -0.04151725964591131i } }), Matrix({ { 0.08839072503868937 + 0.03693304767419581i, 0.016605010278340937 + 0.047919571536273964i, -0.02071338823265517 + 0.17847307281919259i, 0.013171121531223698 + 0.07192195279757133i }, { 0.011667803641887043 + -0.15688122202132285i, -0.09762837508475522 + -0.146153500451715i, 0.1482540563598183 + -0.0038573131585755245i, 0.0324003250988978 + 0.040499166971917994i }, { 0.07810816047019532 + 0.0326122728839976i, 0.18209350349595915 + -0.1045762275789908i, 0.15986338688753302 + -0.014338097116687704i, 0.15818205244136813 + -0.016152715375315017i }, { 0.023977903007932184 + 0.1305393027052383i, 0.12704032283476283 + 0.057249197853157595i, 0.018042832386320446 + -0.03520164420248415i, -0.011287875479429579 + -0.0628079113961924i } }), Matrix({ { 0.005784436949668638 + 0.06054641994764291i, 0.025489444645414628 + -0.09280739963329929i, 0.037830157634931125 + 0.05209159239540572i, 0.11178810161108045 + -0.1060975425343844i }, { -0.016454640474756976 + 0.11188325251829546i, 0.11505308667687571 + 0.0036264002614769713i, -0.06791535181429835 + 0.09314346538181702i, 0.08872254982411353 + -0.10331826443147826i }, { 0.09786836491539712 + 0.022395808989150078i, -0.0874425229020522 + 0.09584971695416153i, 0.07370231604246147 + -0.04729514404576722i, -0.10533744765612052 + 0.045670050975885154i }, { -0.014517437867553683 + -0.08991434122779518i, 0.03011505878367698 + 0.015795266629395108i, -0.09476306012706738 + 0.0024010096769258777i, -0.0005905957332250828 + -0.027292238526124137i } }), Matrix({ { -0.16223220678189515 + -0.07567842613120596i, 0.032507275432044964 + 0.1055586924264892i, 0.01915775931353983 + -0.02531259564582926i, -0.02419050074139681 + 0.07306117102492579i }, { 0.02267240129718939 + 0.08073724200994588i, -0.10322107916429261 + 0.018126617806567862i, 0.05028581237798588 + 0.06438952775623598i, 0.13675429707613562 + -0.004497870776015354i }, { -0.05311421423999743 + -0.004752339401124357i, 0.004167975150344846 + -0.04960725598452424i, -0.02582719525191055 + 0.07447305604442837i, 0.0692192600891515 + 0.03544829113489327i }, { 0.06576594726098285 + 0.0174461816737355i, 0.12844597343322225 + -0.0029106479416834675i, 0.005146038980051733 + 0.01323202412211216i, -0.14789610902008643 + 0.017140877010483443i } }), Matrix({ { -0.08307210035116604 + 0.09894836110345762i, 0.02798873164005839 + 0.0007777071495012474i, -0.13744000257623104 + -0.14840135673393634i, 0.0650557484557793 + 0.049551496375921066i }, { 0.04380538569269675 + 0.1874806977000618i, -0.09299099439729444 + 0.04302585293885584i, -0.04210277591686343 + -0.13946141612141852i, 0.12395030437667445 + -0.07150929473632589i }, { 0.09640754316856645 + -0.09832019603605358i, -0.021281472280819426 + 0.08545976915251262i, 0.02807167504642297 + -0.029386357235541668i, 0.20600882083112673 + -0.027079987992182614i }, { -0.009994779777890761 + -0.07402517788738049i, 0.1173692416548479 + -0.017389051260482655i, 0.13945036353395607 + -0.0060345224646476325i, 0.03616244645465383 + -0.09723768630362864i } }) }, { QubitIndex{ 4 }, QubitIndex{ 5 } }));

    c.addInstruction(CircuitInstruction({ Matrix({ { 0.014941018785417759 + -0.19909184902206953i, 0.23568797437901073 + 0.09921736323759545i }, { 0.02439338139412077 + 0.3583743263865075i, 0.013848785225950677 + -0.22390914463335593i } }), Matrix({ { 0.1228942973437879 + 0.14156661870890325i, 0.3123872183241526 + 0.42699471066437894i }, { -0.3438094439751843 + -0.12071910882760703i, 0.12754876464290377 + 0.5726542297235028i } }), Matrix({ { 0.3120099836119644 + 0.5735959107792072i, -0.07932895950248792 + 0.370595482971221i }, { 0.10004948223544408 + 0.31576624711439033i, -0.0369753091509833 + -0.2760360186382317i } }), Matrix({ { -0.027838448726145486 + -0.2663882766216014i, 0.09649815122771938 + -0.06539339640168682i }, { 0.012461432054058232 + 0.23498117584320788i, 0.15866623652994877 + -0.014417745595073035i } }) }, { QubitIndex{ 5 } }));

    c.addInstruction(CircuitInstruction({ Matrix({ { 0.14087913357398563 + -0.03227323515265556i, -0.024173838291864518 + -0.003828674489005921i, 0.08750551295977346 + -0.06416819554334412i, -0.15849004211419077 + 0.06816844735750974i }, { -0.03264848731853724 + -0.044028156144935486i, -0.06016738291013157 + 0.01635931066285021i, 0.01744177400891242 + -0.09298422293129499i, -0.066816322213828 + -0.039932834181847766i }, { -0.03303673863163362 + -0.042077691423022354i, -0.15771140918154453 + -0.07498161178228198i, -0.039506092423390975 + -0.06693996479363128i, 0.055862599648724885 + -0.07200940196916143i }, { -0.13638937259863362 + -0.14689999215097085i, -0.1254897851272231 + 0.058781448798809914i, 0.08868505069555396 + -0.08993823568290088i, -0.10186064935030184 + 0.03403894702482041i } }), Matrix({ { -0.01250723191638891 + 0.121539292139282i, 0.029841779422880473 + 0.0006429232580353088i, 0.033117046746363336 + 0.04392065135659018i, -0.12334434636084438 + -0.016620683872180908i }, { -0.11908806535401838 + 0.09921826274835954i, -0.11590133278701947 + 0.07920034277674272i, 0.08985726846334331 + 0.05305313007440275i, -0.174859873583806 + 0.1519790628406823i }, { 0.15333560238805172 + 0.04644124984997111i, -0.04247603498301687 + 0.062755595914668i, -0.10529791287618216 + 0.00755617232926075i, -0.06816695350004652 + -0.022889871109881915i }, { -0.02200142881568892 + -0.043939674399818184i, -0.054904727232166786 + 0.11667752347523858i, -0.2831847559546252 + 0.011260833999624548i, 0.10866478647796632 + 0.04247180383202116i } }), Matrix({ { -0.03044382210458594 + -0.07874317876514061i, -0.0786372957106841 + -0.033092262530699496i, 0.03297150187822125 + -0.11464198771013677i, -0.03412438450872049 + -0.010156019708439263i }, { -0.06906686788512191 + 0.0813538687368338i, -0.03363725482813129 + 0.01346075152020003i, -0.10685889894403475 + -0.05683893781841167i, 0.054545035857032506 + -0.060975774900805024i }, { 0.053084757327146403 + -0.1532841977052634i, -0.011406517029593301 + 0.013301134711986838i, 0.14723125693684033 + -0.08630597421847046i, 0.1144637266235125 + 0.16882724222678896i }, { 0.012709943162024024 + -0.0304567208351563i, 0.07151517819123498 + 0.018142964256093116i, 0.0253748534507427 + 0.0011393873989711438i, -0.003021005331508665 + 0.1140180366773663i } }), Matrix({ { 0.057062049770772005 + -0.0793818509337954i, -0.04549301515258828 + 0.04547956421276385i, 0.15010538494182568 + 0.13684954411427797i, 0.03476347622374408 + -0.11439837309831291i }, { 0.07494692262224531 + -0.17313677571797997i, 0.14623647503761344 + 0.0030234228395979042i, -0.026571751414653726 + -0.004981134745071639i, -0.04754018432898945 + 0.0724132371854047i }, { -0.04987238774943387 + -0.10337764381589144i, 0.07074739441332206 + -0.0880663623653252i, 0.11231363935700965 + 0.028972590701664365i, 0.0561929792120499 + 0.11624311707992907i }, { 0.051832851283669254 + 0.09266276457559962i, 0.08915031751814008 + -0.02712731464503841i, -0.04818442756284116 + -0.05272210961990225i, 0.03376679424907895 + 0.025258234639566085i } }), Matrix({ { 0.09096614857034152 + 0.026153798850328137i, -0.09390874353197051 + -0.021290424756607692i, -0.05753145518994871 + -0.008605294050185874i, -0.13820149628229786 + 0.0964343462167057i }, { 0.12316986314158093 + 0.026299061543207238i, -0.013815278472352465 + 0.006502950155576218i, 0.11745839306659309 + -0.15159604254571354i, 0.2040258490168595 + -0.07624025759575402i }, { 0.11718260249008942 + 0.040515677211250746i, 0.029606668534123342 + -0.01519207857160855i, -0.007218529224056941 + 0.04302760461857071i, 0.04457060805248635 + 0.09811183592368353i }, { 0.11012854497860992 + 0.008011174055232037i, 0.12331637283951778 + 0.15957616459310778i, 0.06179758078620807 + -0.019072326639133268i, 0.014513886244873693 + 0.025900620426290044i } }), Matrix({ { 0.027003528116478295 + -0.052276541720381785i, 0.07839614884304524 + -0.009887010618037073i, -0.0698316392946795 + -0.14001670459577228i, -0.06955939930421108 + 0.05852241919391396i }, { 0.08615154772079953 + 0.030678221905321785i, -0.07828477852505643 + -0.09334778451473297i, 0.17706530451809466 + 0.0637435351907957i, 0.048500300227008755 + -0.04606125373247025i }, { 0.16452971666955404 + 0.0913774377532751i, -0.16511353496284903 + -0.1261673315592049i, -0.15569358467476546 + -0.04198026409582395i, 0.16484479043505015 + -0.08688828633755419i }, { -0.13627045493289736 + 0.12950375699770486i, -0.012718054507369013 + 0.11733496736698358i, 0.17654006673060124 + 0.005134054286500046i, -0.08017487859941161 + 0.12974974466544598i } }), Matrix({ { 0.00661528952051362 + 0.013978578458488298i, -0.06945293194229331 + 0.0473037090969129i, -0.09383217631941186 + -0.1235823183782039i, 0.025114138467635886 + -0.10250527192995905i }, { 0.06817917812574563 + -0.058155214907390916i, 0.03937374786726901 + -0.014753971075510474i, -0.08179831654570575 + -0.007496636965388409i, 0.0594902660115792 + -0.014397459353342077i }, { -0.14192808230207407 + 0.06672663005713772i, 0.0051613581851885915 + -0.06937093781917736i, -0.06373677491697387 + -0.10009345054179826i, -0.029714546837404824 + -0.03658714736445972i }, { -0.0363254569904417 + 0.03622934597722967i, 0.013513429366793126 + -0.09488072993208893i, -0.07979286598682774 + 0.11093896426000051i, -0.061312924535642244 + 0.0864728072440094i } }), Matrix({ { 0.05896283628669672 + 0.0422933846443653i, 0.10955688964742223 + -0.009253828599467452i, -0.0022760214746683155 + 0.1482216904128618i, 0.009357758815397984 + 0.1059407101582348i }, { -0.171683822050646 + 0.055917575230798905i, 0.1582876121922225 + 0.13017452488392467i, 0.1610368849272278 + -0.006516015063550276i, -0.08960931553445177 + -0.1849954228306501i }, { -0.08312756143693582 + -0.018640284407700294i, 0.06229264319290939 + 0.06784314061150545i, 0.10814577521377704 + -0.04090049957170549i, 0.03357423837710221 + 0.09215513787783126i }, { 0.1452028404861108 + 0.07813718559767546i, 0.04645304814123498 + -0.06265976193347925i, 0.07967974108218714 + 0.05068708982244481i, -0.06660086387628761 + -0.08849132236203777i } }), Matrix({ { 0.06396381833881173 + -0.1400683942350669i, -0.18911298118367928 + 0.02853453343627891i, -0.142882717636319 + 0.01582471765783102i, -0.1092608264689597 + 0.06574698534816213i }, { -0.012572470924196114 + 0.22962569170017416i, -0.04178831961200516 + -0.018263982185203486i, 0.16580156376151486 + -0.017878837179627818i, -0.03332043222042733 + -0.08615136061932974i }, { 0.04417369516839686 + -0.1452212816536056i, -0.054922975249794476 + 0.0500988298866713i, 0.03653841904263623 + -0.030728477923074735i, 0.03325298937286226 + 0.005997455450102621i }, { 0.02350782428117936 + -0.07763794956187729i, -0.17791834826499275 + -0.02246904170270657i, 0.07477284112983498 + -0.058612410494870336i, 0.09011478672304281 + -0.10535714941700607i } }), Matrix({ { -0.17758781272274934 + 0.10415786128723213i, -0.1933117737103599 + -0.1081304365788294i, -0.09106892706009194 + 0.10997964288348339i, 0.10576160406782191 + 0.23962296833394456i }, { 0.056209591273807556 + 0.011290875267787425i, -0.04893224562994214 + -0.1280136374125469i, 0.03631491721964574 + -0.02091105363737643i, -0.06644127593292565 + -0.09250487302130471i }, { -0.06874874007109673 + -0.10821297216720704i, -0.011973063175783024 + -0.13473180748876104i, -0.1040764027898542 + 0.1152588318117652i, -0.14574603511573594 + -0.023894164971456588i }, { -0.0931525135779958 + -0.0470161909511841i, -0.07418314673872083 + 0.043418831208829785i, 0.06208042336974651 + -0.10054183324337738i, -0.09396684254858166 + 0.01454728717225548i } }), Matrix({ { 0.0017462562284367724 + -0.10086309483364249i, -0.05116351167492804 + -0.06611169066651701i, 0.18459012210851322 + 0.0219038035607315i, -0.013933491438689096 + 0.051051319902721895i }, { -0.030583114563344692 + 0.028746421842224274i, -0.11266476229580914 + -0.043210734893423225i, 0.07873704122178106 + -0.10639562591855073i, 0.09762431979339956 + 0.08657556721395623i }, { -0.011036402361247099 + 0.21450389616039492i, -0.12131110601869215 + -0.11147210261454644i, -0.039922486267955117 + -0.09497643241246655i, -0.07681888000803433 + 0.004666853563451904i }, { 0.06118315028779003 + 0.005515995476582757i, -0.1406104144982594 + -0.089059338748774i, -0.037340829768994194 + 0.044215143433310296i, -0.057216289103973424 + 0.04761701893741341i } }), Matrix({ { 0.16204595813809164 + -0.08276252499383072i, 0.08616613611342729 + -0.12710615591477237i, -0.043106169701929056 + 0.13810047629228395i, -0.0987093765047191 + 0.008619203473855107i }, { -0.017321148834805022 + 0.010916052706926865i, -0.02897616714383572 + 0.0020983772602863643i, 0.09356009019726895 + -0.04127723814085306i, -0.07113814325054908 + 0.06108451499007884i }, { 0.03020895042877608 + -0.10505766103099944i, 0.01454386181802639 + -0.0816504829952506i, -0.060354146678538494 + -0.007278931960895919i, -0.08099008218170022 + 0.19886058356357492i }, { 0.01287529507381987 + 0.08306770441812107i, -0.2510272758073645 + 0.0019968706261140083i, -0.0821065042780154 + 0.12563337320165385i, 0.08047137292042567 + 0.10730567940218529i } }), Matrix({ { 0.02036794438540192 + -0.09096326210221671i, -0.001254181851190768 + -0.031978519052972644i, 0.007643475402107337 + -0.08035620945088592i, 0.11408992409372314 + -0.048586504445167i }, { 0.010389604761095364 + 0.08444092563271931i, -0.050574136588185874 + -0.002043740300251604i, 0.005062729630434689 + -0.06786161688252178i, 0.0252464940475876 + -0.0069403540056788456i }, { -0.06606543651088242 + -0.024957847596454415i, 0.15359896522089492 + 0.10887927868470239i, -0.15392758935351716 + 0.13274174887299187i, -0.029985671157390315 + 0.09425174149562572i }, { -0.050609606901058674 + 0.1045726711148708i, -0.10819033262440195 + -0.004562280855156792i, -0.03978654484928125 + 0.05178721998956629i, -0.09693975790613958 + -0.04314097087981552i } }), Matrix({ { -0.035444029866205706 + -0.051197044758674835i, -0.028917148712366426 + -0.08156447255500547i, -0.03278216623090205 + -0.026652548165510288i, -0.03815907623348059 + -0.08911961323523263i }, { -0.0369910679546651 + -0.10536892105438678i, -0.08343483977284052 + 0.0006502449117381237i, 0.09775268990172382 + -0.0031103727774576097i, 0.05600473042880236 + -0.020303745056475746i }, { 0.007307880161273485 + 0.1101313188514655i, -0.1143559492139943 + -0.047755167480112486i, -0.055275830635816224 + -0.027746592871341864i, -0.08840667143776543 + -0.04335106533194403i }, { 0.06243572483962356 + 0.21581157401436735i, -0.015579363421393419 + 0.0804011844933497i, 0.04274886075862873 + 0.07437827179888065i, -0.03240543312268317 + -0.13303368673283253i } }), Matrix({ { 0.07670887415662869 + 0.06021421946810708i, -0.11630162192685907 + -0.137748716960021i, 0.11424149476746939 + -0.07530674377512625i, -0.003014231118820365 + 0.053440652519955965i }, { -0.06561136686396937 + -0.011364215999464843i, -0.04823828252843831 + 0.15812807530026443i, -0.07394286093665597 + -0.0449946199977119i, -0.17040608835488763 + 0.047167900848927705i }, { 0.06740677792419794 + 0.15147259797200943i, -0.09288158742503215 + 0.019031835645832725i, 0.014363474101655964 + -0.12314342864046206i, 0.06553576338967372 + 0.18001651279430766i }, { 0.1445705447125441 + -0.06719369510481041i, -0.03423191963324732 + -0.036658967944806185i, -0.019506189051219737 + -0.13367354715153806i, -0.10096974911934654 + 0.17120907581880163i } }), Matrix({ { 0.08330505473716461 + -0.033488313328097236i, -0.02310539650734045 + 0.1412137357138878i, 0.09064123944639432 + 0.03674343038568695i, 0.03333445451974498 + 0.05544310614632242i }, { -0.04038886955022635 + 0.089523963779785i, 0.05093337039666966 + -0.23610565396766467i, -0.1432917711856059 + 0.02800696658526563i, 0.07551907979204364 + -0.017637380533233517i }, { 0.02407209510483847 + -0.12257790182243665i, -0.05433469934312776 + -0.19410302141708594i, -0.02926645698810743 + 0.11478943378584493i, 0.02809437363813132 + -0.09211253385906579i }, { 0.01298589549456694 + 0.019394799840731173i, -0.03911318192921429 + 0.01913858128782014i, -0.06801413918250013 + 0.0571040076215829i, 0.07514417317857981 + 0.07201185282080497i } }) }, { QubitIndex{ 1 }, QubitIndex{ 5 } }));

    c.addInstruction(CircuitInstruction({ Matrix({ { -0.07875548848677803 + 0.24054214818645483i, 0.18041831708656306 + -0.12273872356586649i }, { 0.075191025887869 + 0.024247542538411496i, 0.36862612050826093 + 0.1879679347777491i } }), Matrix({ { 0.11817495153396569 + 0.0012421103598524994i, -0.508947096126215 + 0.0752255890165144i }, { 0.049759708866892786 + 0.3820687833105072i, 0.2642649550685519 + -0.17933351899653577i } }), Matrix({ { 0.46597347878043544 + -0.16772495631358353i, -0.16692757540141656 + 0.04729973024715642i }, { 0.0796594725857239 + -0.1485677960562585i, 0.5165135917610341 + 0.08457166194619799i } }), Matrix({ { -0.2003937760423779 + -0.14597078964512292i, -0.236907684941407 + -0.09716441878080069i }, { 0.41147458614402294 + 0.5126582985063431i, 0.037615416325735285 + 0.20847765003591284i } }) }, { QubitIndex{ 4 } }));

    c.addInstruction(CircuitInstruction({ Matrix({ { -0.05589941022181488 + -0.25288581189000103i, 0.2895085254975096 + 0.5610372363990337i }, { 0.2435866840076606 + 0.23100441969429758i, -0.1084275872019297 + -0.22935210754383262i } }), Matrix({ { -0.1088379475080015 + 0.07524566781714226i, 0.11512746520702048 + 0.08050848611120208i }, { -0.24127705107529468 + -0.32370870763809434i, 0.46938491351434286 + -0.1138298368275617i } }), Matrix({ { -0.10068079718502045 + -0.057990027380680265i, -0.14986443806466343 + -0.11944297895458604i }, { -0.5825633789462676 + -0.18617931374946795i, -0.3045217333295369 + 0.15392587370057792i } }), Matrix({ { -0.4723202292547833 + -0.11740240556595889i, -0.2722234393255001 + -0.0566637525431849i }, { 0.12297373067237274 + 0.013505540779209943i, 0.13710466282562536 + -0.18649669634417632i } }) }, { QubitIndex{ 0 } }));


    return c;
}

TEST(RandomizedIntegrationTests, 6_5_2_100_0_0) {
    auto c = randomCircuit();
    
    auto s = c.execute();

    EXPECT_EQ(s.getReducedDensityMatrix({true, false, false, false, false, false}), Matrix({ { 0.33495277725480205 + 0.0i, -0.060350745797403134 + -0.09509373681512717i }, { -0.060350745797403134 + 0.09509373681512717i, 0.6650472227451982 + 9.62964972193618e-35i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({true, false, false, false, false, false}), ElementsAreArray({ DoubleNear(0.33495277725480205, 1.0e-7), DoubleNear(0.6650472227451982, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({false, true, false, false, false, false}), Matrix({ { 0.45319070198835376 + 0.0i, 0.01848420641317918 + 0.015583452200771957i }, { 0.01848420641317918 + -0.015583452200771957i, 0.5468092980116466 + 0.0i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({false, true, false, false, false, false}), ElementsAreArray({ DoubleNear(0.45319070198835376, 1.0e-7), DoubleNear(0.5468092980116466, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({false, false, true, false, false, false}), Matrix({ { 1.0000000000000004 + -9.62964972193618e-35i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({false, false, true, false, false, false}), ElementsAreArray({ DoubleNear(1.0000000000000004, 1.0e-7), DoubleNear(0.0, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({false, false, false, true, false, false}), Matrix({ { 1.0000000000000004 + -9.62964972193618e-35i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({false, false, false, true, false, false}), ElementsAreArray({ DoubleNear(1.0000000000000004, 1.0e-7), DoubleNear(0.0, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({false, false, false, false, true, false}), Matrix({ { 0.4307056684010476 + -2.16840434497101e-18i, -0.17538912205529947 + -0.05300159868108873i }, { -0.17538912205529947 + 0.05300159868108874i, 0.5692943315989528 + 2.1684043449710096e-18i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({false, false, false, false, true, false}), ElementsAreArray({ DoubleNear(0.4307056684010476, 1.0e-7), DoubleNear(0.5692943315989528, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({false, false, false, false, false, true}), Matrix({ { 0.49272826615682375 + 2.16840434497101e-19i, 0.0025359124604948293 + 0.0377404767517979i }, { 0.0025359124604948293 + -0.0377404767517979i, 0.5072717338431767 + -2.168404344971011e-19i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({false, false, false, false, false, true}), ElementsAreArray({ DoubleNear(0.49272826615682375, 1.0e-7), DoubleNear(0.5072717338431767, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({true, true, false, false, false, false}), Matrix({ { 0.15179748425705236 + -2.407412430484045e-35i, -0.027350396853445803 + -0.04309559734194322i, 0.0061913362734453865 + 0.005219720593866023i, 0.0003663530597428173 + -0.0026982052223061166i }, { -0.027350396853445803 + 0.04309559734194322i, 0.30139321773130134 + 2.407412430484045e-35i, -0.0025974243447598275 + 0.0008172592974765754i, 0.012292870139733791 + 0.010363731606905936i }, { 0.0061913362734453865 + -0.005219720593866023i, -0.0025974243447598275 + -0.0008172592974765754i, 0.18315529299774969 + 0.0i, -0.03300034894395733 + -0.05199813947318395i }, { 0.0003663530597428173 + 0.0026982052223061166i, 0.012292870139733791 + -0.010363731606905935i, -0.03300034894395733 + 0.05199813947318395i, 0.3636540050138969 + 0.0i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({true, true, false, false, false, false}), ElementsAreArray({ DoubleNear(0.15179748425705236, 1.0e-7), DoubleNear(0.30139321773130134, 1.0e-7), DoubleNear(0.18315529299774969, 1.0e-7), DoubleNear(0.3636540050138969, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({true, false, true, false, false, false}), Matrix({ { 0.33495277725480205 + 0.0i, -0.060350745797403134 + -0.09509373681512717i, 0.0 + 0.0i, 0.0 + 0.0i }, { -0.060350745797403134 + 0.09509373681512717i, 0.6650472227451982 + 9.62964972193618e-35i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({true, false, true, false, false, false}), ElementsAreArray({ DoubleNear(0.33495277725480205, 1.0e-7), DoubleNear(0.6650472227451982, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({true, false, false, true, false, false}), Matrix({ { 0.33495277725480205 + 0.0i, -0.060350745797403134 + -0.09509373681512717i, 0.0 + 0.0i, 0.0 + 0.0i }, { -0.060350745797403134 + 0.09509373681512717i, 0.6650472227451982 + 9.62964972193618e-35i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({true, false, false, true, false, false}), ElementsAreArray({ DoubleNear(0.33495277725480205, 1.0e-7), DoubleNear(0.6650472227451982, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({true, false, false, false, true, false}), Matrix({ { 0.14426605981031668 + -7.263130575594193e-19i, -0.02599340830717222 + -0.040957411475712635i, -0.058747073532703996 + -0.017753032677175117i, 0.005544744245028644 + 0.01987709302182122i }, { -0.02599340830717222 + 0.040957411475712635i, 0.2864396085907309 + -1.4420912874115904e-18i, 0.015624984396549527 + -0.013479721004104498i, -0.11664204852259547 + -0.035248566003913614i }, { -0.058747073532703996 + 0.01775303267717512i, 0.015624984396549529 + 0.013479721004104498i, 0.19068671744448537 + 7.263130575594193e-19i, -0.03435733749023091 + -0.05413632533941453i }, { 0.005544744245028644 + -0.01987709302182122i, -0.11664204852259547 + 0.03524856600391362i, -0.03435733749023091 + 0.05413632533941453i, 0.37860761415446736 + 1.4420912874115904e-18i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({true, false, false, false, true, false}), ElementsAreArray({ DoubleNear(0.14426605981031668, 1.0e-7), DoubleNear(0.2864396085907309, 1.0e-7), DoubleNear(0.19068671744448537, 1.0e-7), DoubleNear(0.37860761415446736, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({true, false, false, false, false, true}), Matrix({ { 0.1650407011811713 + 7.263130575594196e-20i, -0.02973651833802565 + -0.04685537206329091i, 0.0008494109215178005 + 0.012641277502934992i, 0.0034358387552451027 + -0.002518815310825053i }, { -0.02973651833802565 + 0.04685537206329091i, 0.3276875649756523 + 1.4420912874115902e-19i, -0.003741927171780684 + -0.00203651652661606i, 0.001686501538977028 + 0.025099199248862905i }, { 0.0008494109215178014 + -0.012641277502934992i, -0.003741927171780684 + 0.0020365165266160597i, 0.16991207607363074 + -7.263130575594196e-20i, -0.030614227459377485 + -0.048238364751836266i }, { 0.0034358387552451027 + 0.002518815310825053i, 0.001686501538977028 + -0.0250991992488629i, -0.030614227459377485 + 0.048238364751836266i, 0.3373596577695459 + -1.4420912874115892e-19i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({true, false, false, false, false, true}), ElementsAreArray({ DoubleNear(0.1650407011811713, 1.0e-7), DoubleNear(0.3276875649756523, 1.0e-7), DoubleNear(0.16991207607363074, 1.0e-7), DoubleNear(0.3373596577695459, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({false, true, true, false, false, false}), Matrix({ { 0.45319070198835376 + 0.0i, 0.01848420641317918 + 0.015583452200771957i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.01848420641317918 + -0.015583452200771957i, 0.5468092980116466 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({false, true, true, false, false, false}), ElementsAreArray({ DoubleNear(0.45319070198835376, 1.0e-7), DoubleNear(0.5468092980116466, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({false, true, false, true, false, false}), Matrix({ { 0.45319070198835376 + 0.0i, 0.01848420641317918 + 0.015583452200771957i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.01848420641317918 + -0.015583452200771957i, 0.5468092980116466 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({false, true, false, true, false, false}), ElementsAreArray({ DoubleNear(0.45319070198835376, 1.0e-7), DoubleNear(0.5468092980116466, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({false, true, false, false, true, false}), Matrix({ { 0.19509019680013553 + -8.67361737988404e-19i, 0.007366166912293151 + 0.006458509117754727i, -0.07941212182935571 + -0.023862566063382877i, -0.002239678181616268 + -0.0023316944060075635i }, { 0.007366166912293151 + -0.006458509117754727i, 0.23561547160091206 + -1.3010426069826059e-18i, -0.003007103664413627 + 0.002618357780667494i, -0.09597700022594376 + -0.029139032617705854i }, { -0.07941212182935571 + 0.023862566063382877i, -0.003007103664413627 + -0.0026183577806674933i, 0.2581005051882182 + 8.67361737988404e-19i, 0.01111803950088603 + 0.00912494308301723i }, { -0.002239678181616268 + 0.0023316944060075635i, -0.09597700022594376 + 0.02913903261770586i, 0.01111803950088603 + -0.00912494308301723i, 0.31119382641073456 + 1.3010426069826059e-18i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({false, true, false, false, true, false}), ElementsAreArray({ DoubleNear(0.19509019680013553, 1.0e-7), DoubleNear(0.23561547160091206, 1.0e-7), DoubleNear(0.2581005051882182, 1.0e-7), DoubleNear(0.31119382641073456, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({false, true, false, false, false, true}), Matrix({ { 0.22058170095023713 + 2.16840434497101e-19i, 0.04425216317885334 + 0.000706798599494857i, -0.02550922934412049 + -0.007916631796881273i, 0.006812329954901254 + 0.019626364304906146i }, { 0.04425216317885334 + -0.0007067985994948566i, 0.27214656520658653 + 0.0i, 0.04240135757692007 + -0.034517656701219125i, 0.028045141804615318 + 0.045657108548679166i }, { -0.02550922934412049 + 0.007916631796881275i, 0.04240135757692007 + 0.034517656701219125i, 0.2326090010381166 + -2.16840434497101e-19i, -0.025767956765674158 + 0.014876653601277101i }, { 0.006812329954901254 + -0.01962636430490615i, 0.028045141804615318 + -0.045657108548679166i, -0.025767956765674158 + -0.014876653601277101i, 0.27466273280506004 + 0.0i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({false, true, false, false, false, true}), ElementsAreArray({ DoubleNear(0.22058170095023713, 1.0e-7), DoubleNear(0.27214656520658653, 1.0e-7), DoubleNear(0.2326090010381166, 1.0e-7), DoubleNear(0.27466273280506004, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({false, false, true, true, false, false}), Matrix({ { 1.0000000000000004 + -9.62964972193618e-35i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({false, false, true, true, false, false}), ElementsAreArray({ DoubleNear(1.0000000000000004, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({false, false, true, false, true, false}), Matrix({ { 0.4307056684010476 + -2.16840434497101e-18i, 0.0 + 0.0i, -0.17538912205529947 + -0.05300159868108873i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { -0.17538912205529947 + 0.05300159868108874i, 0.0 + 0.0i, 0.5692943315989528 + 2.1684043449710096e-18i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({false, false, true, false, true, false}), ElementsAreArray({ DoubleNear(0.4307056684010476, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.5692943315989528, 1.0e-7), DoubleNear(0.0, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({false, false, true, false, false, true}), Matrix({ { 0.49272826615682375 + 2.16840434497101e-19i, 0.0 + 0.0i, 0.0025359124604948293 + 0.0377404767517979i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0025359124604948293 + -0.0377404767517979i, 0.0 + 0.0i, 0.5072717338431767 + -2.168404344971011e-19i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({false, false, true, false, false, true}), ElementsAreArray({ DoubleNear(0.49272826615682375, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.5072717338431767, 1.0e-7), DoubleNear(0.0, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({false, false, false, true, true, false}), Matrix({ { 0.4307056684010476 + -2.16840434497101e-18i, 0.0 + 0.0i, -0.17538912205529947 + -0.05300159868108873i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { -0.17538912205529947 + 0.05300159868108874i, 0.0 + 0.0i, 0.5692943315989528 + 2.1684043449710096e-18i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({false, false, false, true, true, false}), ElementsAreArray({ DoubleNear(0.4307056684010476, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.5692943315989528, 1.0e-7), DoubleNear(0.0, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({false, false, false, true, false, true}), Matrix({ { 0.49272826615682375 + 2.16840434497101e-19i, 0.0 + 0.0i, 0.0025359124604948293 + 0.0377404767517979i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0025359124604948293 + -0.0377404767517979i, 0.0 + 0.0i, 0.5072717338431767 + -2.168404344971011e-19i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({false, false, false, true, false, true}), ElementsAreArray({ DoubleNear(0.49272826615682375, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.5072717338431767, 1.0e-7), DoubleNear(0.0, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({false, false, false, false, true, true}), Matrix({ { 0.21241334806069598 + -6.5052130349130295e-19i, -0.08655541591958893 + -0.0264375044100091i, 0.0008889856553433734 + 0.015858151866214056i, 0.0011120388247316633 + -0.005886674278241833i }, { -0.08655541591958893 + 0.026437504410009104i, 0.28031491809612774 + 8.67361737988404e-19i, -0.0014343121612378747 + -0.006536945239942406i, 0.0016469268051514559 + 0.021882324885583837i }, { 0.0008889856553433734 + -0.015858151866214056i, -0.001434312161237873 + 0.006536945239942406i, 0.21829232034035162 + -1.517883041479707e-18i, -0.08883370613571054 + -0.02656409427107963i }, { 0.0011120388247316637 + 0.005886674278241832i, 0.0016469268051514559 + -0.021882324885583837i, -0.08883370613571054 + 0.026564094271079634i, 0.2889794135028251 + 1.3010426069826059e-18i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({false, false, false, false, true, true}), ElementsAreArray({ DoubleNear(0.21241334806069598, 1.0e-7), DoubleNear(0.28031491809612774, 1.0e-7), DoubleNear(0.21829232034035162, 1.0e-7), DoubleNear(0.2889794135028251, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({true, true, true, false, false, false}), Matrix({ { 0.15179748425705236 + -2.407412430484045e-35i, -0.027350396853445803 + -0.04309559734194322i, 0.0061913362734453865 + 0.005219720593866023i, 0.0003663530597428173 + -0.0026982052223061166i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { -0.027350396853445803 + 0.04309559734194322i, 0.30139321773130134 + 2.407412430484045e-35i, -0.0025974243447598275 + 0.0008172592974765754i, 0.012292870139733791 + 0.010363731606905936i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0061913362734453865 + -0.005219720593866023i, -0.0025974243447598275 + -0.0008172592974765754i, 0.18315529299774969 + 0.0i, -0.03300034894395733 + -0.05199813947318395i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0003663530597428173 + 0.0026982052223061166i, 0.012292870139733791 + -0.010363731606905935i, -0.03300034894395733 + 0.05199813947318395i, 0.3636540050138969 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({true, true, true, false, false, false}), ElementsAreArray({ DoubleNear(0.15179748425705236, 1.0e-7), DoubleNear(0.30139321773130134, 1.0e-7), DoubleNear(0.18315529299774969, 1.0e-7), DoubleNear(0.3636540050138969, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({true, true, false, true, false, false}), Matrix({ { 0.15179748425705236 + -2.407412430484045e-35i, -0.027350396853445803 + -0.04309559734194322i, 0.0061913362734453865 + 0.005219720593866023i, 0.0003663530597428173 + -0.0026982052223061166i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { -0.027350396853445803 + 0.04309559734194322i, 0.30139321773130134 + 2.407412430484045e-35i, -0.0025974243447598275 + 0.0008172592974765754i, 0.012292870139733791 + 0.010363731606905936i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0061913362734453865 + -0.005219720593866023i, -0.0025974243447598275 + -0.0008172592974765754i, 0.18315529299774969 + 0.0i, -0.03300034894395733 + -0.05199813947318395i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0003663530597428173 + 0.0026982052223061166i, 0.012292870139733791 + -0.010363731606905935i, -0.03300034894395733 + 0.05199813947318395i, 0.3636540050138969 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({true, true, false, true, false, false}), ElementsAreArray({ DoubleNear(0.15179748425705236, 1.0e-7), DoubleNear(0.30139321773130134, 1.0e-7), DoubleNear(0.18315529299774969, 1.0e-7), DoubleNear(0.3636540050138969, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({true, true, false, false, true, false}), Matrix({ { 0.06534600323339126 + -2.9052522302376776e-19i, -0.011773838874650324 + -0.018551855829723445i, 0.0024673180649950202 + 0.0021632955659174067i, 0.00016961009943682135 + -0.0010902521796897285i, -0.02659931075443938 + -0.007992832775356281i, 0.0025234002007909376 + 0.008991719071736525i, -0.0007501864270893538 + -0.0007810075170017193i, -8.656328557147397e-05 + 0.0003536988639273893i }, { -0.011773838874650324 + 0.018551855829723445i, 0.12974419356674427 + -5.768365149646362e-19i, -0.0010587174330869125 + 0.0003107004956980767i, 0.00489884884729813 + 0.004295213551837321i, 0.00706176135472077 + -0.0061114717546066075i, -0.05281281107491634 + -0.015869733288026596i, 0.0003568957827849009 + -7.225987117901063e-05i, -0.0014894917545269144 + -0.0015506868890058443i }, { 0.0024673180649950202 + -0.0021632955659174067i, -0.0010587174330869125 + -0.0003107004956980767i, 0.07892005657692541 + -4.357878345356516e-19i, -0.014219569432521896 + -0.022405555645989193i, -0.0010072377238884364 + 0.0008770262104812968i, 0.00043047037452010136 + 0.0001279368796118373i, -0.032147762778264616 + -0.009760199901818837i, 0.003021344044237707 + 0.010885373950084699i }, { 0.00016961009943682135 + 0.0010902521796897283i, 0.00489884884729813 + -0.004295213551837321i, -0.014219569432521896 + 0.022405555645989193i, 0.15669541502398665 + -8.652547724469543e-19i, -6.75084768451688e-05 + -0.00044397656926727043i, -0.0019998659405251916 + 0.0017413315701861976i, 0.008563223041828757 + -0.0073682492494978906i, -0.06382923744767914 + -0.019378832715887015i }, { -0.02659931075443938 + 0.007992832775356281i, 0.00706176135472077 + 0.006111471754606607i, -0.0010072377238884364 + -0.0008770262104812967i, -6.75084768451688e-05 + 0.00044397656926727043i, 0.0864514810236611 + 2.9052522302376776e-19i, -0.01557655797879548 + -0.02454374151221978i, 0.003724018208450368 + 0.0030564250279486167i, 0.00019674296030599593 + -0.0016079530426163884i }, { 0.002523400200790937 + -0.008991719071736525i, -0.05281281107491634 + 0.0158697332880266i, 0.0004304703745201013 + -0.0001279368796118373i, -0.0019998659405251916 + -0.0017413315701861971i, -0.01557655797879548 + 0.02454374151221978i, 0.17164902416455707 + 5.768365149646362e-19i, -0.001538706911672915 + 0.0005065588017784989i, 0.007394021292435663 + 0.006068518055068615i }, { -0.0007501864270893538 + 0.0007810075170017193i, 0.0003568957827849009 + 7.225987117901063e-05i, -0.032147762778264616 + 0.009760199901818839i, 0.00856322304182876 + 0.0073682492494978906i, 0.003724018208450368 + -0.0030564250279486163i, -0.001538706911672915 + -0.0005065588017784989i, 0.10423523642082427 + 4.357878345356516e-19i, -0.018780779511435433 + -0.029592583827194752i }, { -8.656328557147397e-05 + -0.0003536988639273893i, -0.0014894917545269144 + 0.0015506868890058443i, 0.0030213440442377064 + -0.010885373950084699i, -0.06382923744767914 + 0.019378832715887022i, 0.00019674296030599593 + 0.0016079530426163884i, 0.007394021292435663 + -0.006068518055068615i, -0.018780779511435433 + 0.029592583827194752i, 0.2069585899899103 + 8.652547724469543e-19i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({true, true, false, false, true, false}), ElementsAreArray({ DoubleNear(0.06534600323339126, 1.0e-7), DoubleNear(0.12974419356674427, 1.0e-7), DoubleNear(0.07892005657692541, 1.0e-7), DoubleNear(0.15669541502398665, 1.0e-7), DoubleNear(0.0864514810236611, 1.0e-7), DoubleNear(0.17164902416455707, 1.0e-7), DoubleNear(0.10423523642082427, 1.0e-7), DoubleNear(0.2069585899899103, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({true, true, false, false, false, true}), Matrix({ { 0.07388445334487011 + 7.263130575594194e-20i, -0.013312270161606552 + -0.02097593821639493i, 0.014822384956289611 + 0.0002367441538606068i, -0.0026034389309905156 + -0.004250759381438014i, -0.008544387214442848 + -0.002651697806869056i, 0.0007866789150797768 + 0.0029035425747517326i, 0.0022818088379702546 + 0.006573905231342825i, 0.0014552151284522707 + -0.0018322756349218041i }, { -0.013312270161606552 + 0.02097593821639493i, 0.146697247605367 + 1.4420912874115904e-19i, -0.002737863170993844 + 0.004165447736221865i, 0.029429778222563728 + 0.00047005444563425023i, 0.0022923231161895664 + -0.001947993308461292i, -0.01696484212967764 + -0.0052649339900122175i, -0.0022774735152448307 + -0.0005366558112634304i, 0.004530521116930999 + 0.013052459073563321i }, { 0.014822384956289611 + -0.00023674415386060665i, -0.002737863170993844 + -0.004165447736221865i, 0.09115624783630122 + 0.0i, -0.016424248176419097 + -0.025879433846895977i, 0.014202452479763317 + -0.011561784976401172i, -0.005841366514410137 + -0.0019489372129264304i, 0.009393798135960647 + 0.015292975309804047i, 0.002649159840165326 + -0.0054223578855767856i }, { -0.0026034389309905156 + 0.004250759381438014i, 0.029429778222563728 + -0.0004700544456342499i, -0.016424248176419097 + 0.025879433846895977i, 0.18099031737028531 + 0.0i, 0.000723459409231146 + 0.006115269863121038i, 0.02819890509715675 + -0.022955871724817955i, -0.00603425028797025 + -8.85232181547682e-05i, 0.018651343668654667 + 0.030364133238875123i }, { -0.008544387214442848 + 0.0026516978068690565i, 0.0022923231161895664 + 0.001947993308461292i, 0.014202452479763317 + 0.011561784976401172i, 0.000723459409231146 + -0.006115269863121038i, 0.07791303091218227 + -7.263130575594196e-20i, -0.01403812669183925 + -0.022119659125548294i, -0.008631048682844224 + 0.004982976440005416i, 0.002969791990733333 + 0.0015525541591318972i }, { 0.0007866789150797766 + -0.0029035425747517326i, -0.01696484212967764 + 0.005264933990012219i, -0.005841366514410137 + 0.0019489372129264304i, 0.02819890509715675 + 0.022955871724817955i, -0.01403812669183925 + 0.022119659125548294i, 0.15469597012593433 + -1.4420912874115902e-19i, 0.00014043882623401675 + -0.0033481884387452894i, -0.017136908082829937 + 0.009893677161271685i }, { 0.0022818088379702546 + -0.006573905231342825i, -0.002277473515244831 + 0.0005366558112634304i, 0.009393798135960649 + -0.015292975309804047i, -0.00603425028797025 + 8.852321815476798e-05i, -0.008631048682844224 + -0.004982976440005416i, 0.00014043882623401675 + 0.0033481884387452894i, 0.09199904516144847 + 0.0i, -0.01657610076753823 + -0.02611870562628797i }, { 0.001455215128452271 + 0.0018322756349218041i, 0.004530521116930999 + -0.013052459073563323i, 0.002649159840165326 + 0.005422357885576786i, 0.018651343668654667 + -0.030364133238875123i, 0.002969791990733333 + -0.0015525541591318974i, -0.017136908082829937 + -0.009893677161271685i, -0.01657610076753823 + 0.02611870562628797i, 0.18266368764361157 + 0.0i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({true, true, false, false, false, true}), ElementsAreArray({ DoubleNear(0.07388445334487011, 1.0e-7), DoubleNear(0.146697247605367, 1.0e-7), DoubleNear(0.09115624783630122, 1.0e-7), DoubleNear(0.18099031737028531, 1.0e-7), DoubleNear(0.07791303091218227, 1.0e-7), DoubleNear(0.15469597012593433, 1.0e-7), DoubleNear(0.09199904516144847, 1.0e-7), DoubleNear(0.18266368764361157, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({true, false, true, true, false, false}), Matrix({ { 0.33495277725480205 + 0.0i, -0.060350745797403134 + -0.09509373681512717i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { -0.060350745797403134 + 0.09509373681512717i, 0.6650472227451982 + 9.62964972193618e-35i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({true, false, true, true, false, false}), ElementsAreArray({ DoubleNear(0.33495277725480205, 1.0e-7), DoubleNear(0.6650472227451982, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({true, false, true, false, true, false}), Matrix({ { 0.14426605981031668 + -7.263130575594193e-19i, -0.02599340830717222 + -0.040957411475712635i, 0.0 + 0.0i, 0.0 + 0.0i, -0.058747073532703996 + -0.017753032677175117i, 0.005544744245028644 + 0.01987709302182122i, 0.0 + 0.0i, 0.0 + 0.0i }, { -0.02599340830717222 + 0.040957411475712635i, 0.2864396085907309 + -1.4420912874115904e-18i, 0.0 + 0.0i, 0.0 + 0.0i, 0.015624984396549527 + -0.013479721004104498i, -0.11664204852259547 + -0.035248566003913614i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { -0.058747073532703996 + 0.01775303267717512i, 0.015624984396549529 + 0.013479721004104498i, 0.0 + 0.0i, 0.0 + 0.0i, 0.19068671744448537 + 7.263130575594193e-19i, -0.03435733749023091 + -0.05413632533941453i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.005544744245028644 + -0.01987709302182122i, -0.11664204852259547 + 0.03524856600391362i, 0.0 + 0.0i, 0.0 + 0.0i, -0.03435733749023091 + 0.05413632533941453i, 0.37860761415446736 + 1.4420912874115904e-18i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({true, false, true, false, true, false}), ElementsAreArray({ DoubleNear(0.14426605981031668, 1.0e-7), DoubleNear(0.2864396085907309, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.19068671744448537, 1.0e-7), DoubleNear(0.37860761415446736, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({true, false, true, false, false, true}), Matrix({ { 0.1650407011811713 + 7.263130575594196e-20i, -0.02973651833802565 + -0.04685537206329091i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0008494109215178005 + 0.012641277502934992i, 0.0034358387552451027 + -0.002518815310825053i, 0.0 + 0.0i, 0.0 + 0.0i }, { -0.02973651833802565 + 0.04685537206329091i, 0.3276875649756523 + 1.4420912874115902e-19i, 0.0 + 0.0i, 0.0 + 0.0i, -0.003741927171780684 + -0.00203651652661606i, 0.001686501538977028 + 0.025099199248862905i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0008494109215178014 + -0.012641277502934992i, -0.003741927171780684 + 0.0020365165266160597i, 0.0 + 0.0i, 0.0 + 0.0i, 0.16991207607363074 + -7.263130575594196e-20i, -0.030614227459377485 + -0.048238364751836266i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0034358387552451027 + 0.002518815310825053i, 0.001686501538977028 + -0.0250991992488629i, 0.0 + 0.0i, 0.0 + 0.0i, -0.030614227459377485 + 0.048238364751836266i, 0.3373596577695459 + -1.4420912874115892e-19i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({true, false, true, false, false, true}), ElementsAreArray({ DoubleNear(0.1650407011811713, 1.0e-7), DoubleNear(0.3276875649756523, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.16991207607363074, 1.0e-7), DoubleNear(0.3373596577695459, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({true, false, false, true, true, false}), Matrix({ { 0.14426605981031668 + -7.263130575594193e-19i, -0.02599340830717222 + -0.040957411475712635i, 0.0 + 0.0i, 0.0 + 0.0i, -0.058747073532703996 + -0.017753032677175117i, 0.005544744245028644 + 0.01987709302182122i, 0.0 + 0.0i, 0.0 + 0.0i }, { -0.02599340830717222 + 0.040957411475712635i, 0.2864396085907309 + -1.4420912874115904e-18i, 0.0 + 0.0i, 0.0 + 0.0i, 0.015624984396549527 + -0.013479721004104498i, -0.11664204852259547 + -0.035248566003913614i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { -0.058747073532703996 + 0.01775303267717512i, 0.015624984396549529 + 0.013479721004104498i, 0.0 + 0.0i, 0.0 + 0.0i, 0.19068671744448537 + 7.263130575594193e-19i, -0.03435733749023091 + -0.05413632533941453i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.005544744245028644 + -0.01987709302182122i, -0.11664204852259547 + 0.03524856600391362i, 0.0 + 0.0i, 0.0 + 0.0i, -0.03435733749023091 + 0.05413632533941453i, 0.37860761415446736 + 1.4420912874115904e-18i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({true, false, false, true, true, false}), ElementsAreArray({ DoubleNear(0.14426605981031668, 1.0e-7), DoubleNear(0.2864396085907309, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.19068671744448537, 1.0e-7), DoubleNear(0.37860761415446736, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({true, false, false, true, false, true}), Matrix({ { 0.1650407011811713 + 7.263130575594196e-20i, -0.02973651833802565 + -0.04685537206329091i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0008494109215178005 + 0.012641277502934992i, 0.0034358387552451027 + -0.002518815310825053i, 0.0 + 0.0i, 0.0 + 0.0i }, { -0.02973651833802565 + 0.04685537206329091i, 0.3276875649756523 + 1.4420912874115902e-19i, 0.0 + 0.0i, 0.0 + 0.0i, -0.003741927171780684 + -0.00203651652661606i, 0.001686501538977028 + 0.025099199248862905i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0008494109215178014 + -0.012641277502934992i, -0.003741927171780684 + 0.0020365165266160597i, 0.0 + 0.0i, 0.0 + 0.0i, 0.16991207607363074 + -7.263130575594196e-20i, -0.030614227459377485 + -0.048238364751836266i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0034358387552451027 + 0.002518815310825053i, 0.001686501538977028 + -0.0250991992488629i, 0.0 + 0.0i, 0.0 + 0.0i, -0.030614227459377485 + 0.048238364751836266i, 0.3373596577695459 + -1.4420912874115892e-19i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({true, false, false, true, false, true}), ElementsAreArray({ DoubleNear(0.1650407011811713, 1.0e-7), DoubleNear(0.3276875649756523, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.16991207607363074, 1.0e-7), DoubleNear(0.3373596577695459, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({true, false, false, false, true, true}), Matrix({ { 0.07114844085892101 + -2.178939172678258e-19i, -0.012819303972786373 + -0.020199179016503817i, -0.028991976948710807 + -0.008855315525818622i, 0.002709642817137441 + 0.009826401049547438i, 0.00029776821419694264 + 0.005311732009716819i, 0.0014543599726369115 + -0.001041588260036144i, 0.0003724804927590367 + -0.001971757898291508i, -0.0006268982269597308 + 0.0002495172556310481i }, { -0.012819303972786373 + 0.020199179016503817i, 0.14126490720177495 + -4.3262738622347716e-19i, 0.007737724989965778 + -0.006635354833215073i, -0.057563438970878116 + -0.017582188884190476i, -0.0015616618672432427 + -0.0008725143241528527i, 0.0005912174411464299 + 0.010546419856497239i, 0.0004926734821032837 + 0.0004610131102855203i, 0.0007395583319726267 + -0.003914916379950324i }, { -0.028991976948710807 + 0.008855315525818624i, 0.007737724989965779 + 0.006635354833215073i, 0.09389226032225031 + 2.9052522302376776e-19i, -0.016917214365239276 + -0.02665619304678709i, -0.0004804268418569632 + -0.002189567962881267i, -0.0005350607415849904 + 0.000530903623638799i, 0.0005516427073208579 + 0.007329545493218173i, 0.0019814787826081914 + -0.001477227050788909i }, { 0.0027096428171374406 + -0.009826401049547438i, -0.057563438970878116 + 0.017582188884190483i, -0.016917214365239276 + 0.02665619304678709i, 0.1864226577738774 + 5.768365149646362e-19i, 0.000708184358858972 + 0.0002581154172958178i, -0.0009538853193809113 + -0.004347377277061139i, -0.002180265304537441 + -0.0011640022024632074i, 0.001095284097830598 + 0.014552779392365664i }, { 0.0002977682141969435 + -0.005311732009716819i, -0.0015616618672432427 + 0.0008725143241528525i, -0.0004804268418569628 + 0.002189567962881267i, 0.0007081843588589721 + -0.00025811541729581797i, 0.07311761895139567 + -5.0841914029159355e-19i, -0.013174104334385848 + -0.020758232459208822i, -0.02975509658399319 + -0.008897717151356496i, 0.0028351014278912034 + 0.010050691972273783i }, { 0.0014543599726369112 + 0.0010415882600361443i, 0.0005912174411464299 + -0.010546419856497239i, -0.0005350607415849906 + -0.0005309036236387989i, -0.00095388531938091 + 0.00434737727706114i, -0.013174104334385848 + 0.020758232459208822i, 0.14517470138895594 + -1.0094639011881132e-18i, 0.00788725940658375 + -0.006844366170889425i, -0.059078609551717357 + -0.017666377119723135i }, { 0.0003724804927590367 + 0.001971757898291508i, 0.0004926734821032836 + -0.0004610131102855203i, 0.0005516427073208579 + -0.007329545493218172i, -0.002180265304537441 + 0.0011640022024632074i, -0.02975509658399319 + 0.008897717151356496i, 0.00788725940658375 + 0.006844366170889425i, 0.09679445712223506 + 4.357878345356516e-19i, -0.017440123124991637 + -0.02748013229262744i }, { -0.0006268982269597308 + -0.0002495172556310481i, 0.0007395583319726269 + 0.003914916379950324i, 0.0019814787826081914 + 0.001477227050788909i, 0.001095284097830598 + -0.014552779392365663i, 0.002835101427891203 + -0.010050691972273783i, -0.059078609551717357 + 0.017666377119723138i, -0.017440123124991637 + 0.02748013229262744i, 0.19218495638058997 + 8.652547724469543e-19i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({true, false, false, false, true, true}), ElementsAreArray({ DoubleNear(0.07114844085892101, 1.0e-7), DoubleNear(0.14126490720177495, 1.0e-7), DoubleNear(0.09389226032225031, 1.0e-7), DoubleNear(0.1864226577738774, 1.0e-7), DoubleNear(0.07311761895139567, 1.0e-7), DoubleNear(0.14517470138895594, 1.0e-7), DoubleNear(0.09679445712223506, 1.0e-7), DoubleNear(0.19218495638058997, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({false, true, true, true, false, false}), Matrix({ { 0.45319070198835376 + 0.0i, 0.01848420641317918 + 0.015583452200771957i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.01848420641317918 + -0.015583452200771957i, 0.5468092980116466 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({false, true, true, true, false, false}), ElementsAreArray({ DoubleNear(0.45319070198835376, 1.0e-7), DoubleNear(0.5468092980116466, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({false, true, true, false, true, false}), Matrix({ { 0.19509019680013553 + -8.67361737988404e-19i, 0.007366166912293151 + 0.006458509117754727i, 0.0 + 0.0i, 0.0 + 0.0i, -0.07941212182935571 + -0.023862566063382877i, -0.002239678181616268 + -0.0023316944060075635i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.007366166912293151 + -0.006458509117754727i, 0.23561547160091206 + -1.3010426069826059e-18i, 0.0 + 0.0i, 0.0 + 0.0i, -0.003007103664413627 + 0.002618357780667494i, -0.09597700022594376 + -0.029139032617705854i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { -0.07941212182935571 + 0.023862566063382877i, -0.003007103664413627 + -0.0026183577806674933i, 0.0 + 0.0i, 0.0 + 0.0i, 0.2581005051882182 + 8.67361737988404e-19i, 0.01111803950088603 + 0.00912494308301723i, 0.0 + 0.0i, 0.0 + 0.0i }, { -0.002239678181616268 + 0.0023316944060075635i, -0.09597700022594376 + 0.02913903261770586i, 0.0 + 0.0i, 0.0 + 0.0i, 0.01111803950088603 + -0.00912494308301723i, 0.31119382641073456 + 1.3010426069826059e-18i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({false, true, true, false, true, false}), ElementsAreArray({ DoubleNear(0.19509019680013553, 1.0e-7), DoubleNear(0.23561547160091206, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.2581005051882182, 1.0e-7), DoubleNear(0.31119382641073456, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({false, true, true, false, false, true}), Matrix({ { 0.22058170095023713 + 2.16840434497101e-19i, 0.04425216317885334 + 0.000706798599494857i, 0.0 + 0.0i, 0.0 + 0.0i, -0.02550922934412049 + -0.007916631796881273i, 0.006812329954901254 + 0.019626364304906146i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.04425216317885334 + -0.0007067985994948566i, 0.27214656520658653 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.04240135757692007 + -0.034517656701219125i, 0.028045141804615318 + 0.045657108548679166i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { -0.02550922934412049 + 0.007916631796881275i, 0.04240135757692007 + 0.034517656701219125i, 0.0 + 0.0i, 0.0 + 0.0i, 0.2326090010381166 + -2.16840434497101e-19i, -0.025767956765674158 + 0.014876653601277101i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.006812329954901254 + -0.01962636430490615i, 0.028045141804615318 + -0.045657108548679166i, 0.0 + 0.0i, 0.0 + 0.0i, -0.025767956765674158 + -0.014876653601277101i, 0.27466273280506004 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({false, true, true, false, false, true}), ElementsAreArray({ DoubleNear(0.22058170095023713, 1.0e-7), DoubleNear(0.27214656520658653, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.2326090010381166, 1.0e-7), DoubleNear(0.27466273280506004, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({false, true, false, true, true, false}), Matrix({ { 0.19509019680013553 + -8.67361737988404e-19i, 0.007366166912293151 + 0.006458509117754727i, 0.0 + 0.0i, 0.0 + 0.0i, -0.07941212182935571 + -0.023862566063382877i, -0.002239678181616268 + -0.0023316944060075635i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.007366166912293151 + -0.006458509117754727i, 0.23561547160091206 + -1.3010426069826059e-18i, 0.0 + 0.0i, 0.0 + 0.0i, -0.003007103664413627 + 0.002618357780667494i, -0.09597700022594376 + -0.029139032617705854i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { -0.07941212182935571 + 0.023862566063382877i, -0.003007103664413627 + -0.0026183577806674933i, 0.0 + 0.0i, 0.0 + 0.0i, 0.2581005051882182 + 8.67361737988404e-19i, 0.01111803950088603 + 0.00912494308301723i, 0.0 + 0.0i, 0.0 + 0.0i }, { -0.002239678181616268 + 0.0023316944060075635i, -0.09597700022594376 + 0.02913903261770586i, 0.0 + 0.0i, 0.0 + 0.0i, 0.01111803950088603 + -0.00912494308301723i, 0.31119382641073456 + 1.3010426069826059e-18i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({false, true, false, true, true, false}), ElementsAreArray({ DoubleNear(0.19509019680013553, 1.0e-7), DoubleNear(0.23561547160091206, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.2581005051882182, 1.0e-7), DoubleNear(0.31119382641073456, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({false, true, false, true, false, true}), Matrix({ { 0.22058170095023713 + 2.16840434497101e-19i, 0.04425216317885334 + 0.000706798599494857i, 0.0 + 0.0i, 0.0 + 0.0i, -0.02550922934412049 + -0.007916631796881273i, 0.006812329954901254 + 0.019626364304906146i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.04425216317885334 + -0.0007067985994948566i, 0.27214656520658653 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.04240135757692007 + -0.034517656701219125i, 0.028045141804615318 + 0.045657108548679166i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { -0.02550922934412049 + 0.007916631796881275i, 0.04240135757692007 + 0.034517656701219125i, 0.0 + 0.0i, 0.0 + 0.0i, 0.2326090010381166 + -2.16840434497101e-19i, -0.025767956765674158 + 0.014876653601277101i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.006812329954901254 + -0.01962636430490615i, 0.028045141804615318 + -0.045657108548679166i, 0.0 + 0.0i, 0.0 + 0.0i, -0.025767956765674158 + -0.014876653601277101i, 0.27466273280506004 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({false, true, false, true, false, true}), ElementsAreArray({ DoubleNear(0.22058170095023713, 1.0e-7), DoubleNear(0.27214656520658653, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.2326090010381166, 1.0e-7), DoubleNear(0.27466273280506004, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({false, true, false, false, true, true}), Matrix({ { 0.09488169763934465 + 0.0i, 0.019285144852098236 + 0.00042986303556029695i, -0.03856542478051253 + -0.011450517154226382i, -0.007791988583477511 + -0.0030432590519579006i, -0.011161780212710444 + -0.003711652687938525i, 0.0029435331436626455 + 0.008209947595620805i, 0.0036623362038119335 + 0.003448641096887732i, -0.0006758990409742605 + -0.0037344653613903527i }, { 0.019285144852098236 + -0.0004298630355602968i, 0.11753165042135133 + -6.5052130349130295e-19i, -0.008279604971694731 + -0.0025980345057980223i, -0.04798999113907639 + -0.014986987255782718i, 0.017088301563320293 + -0.014889827322563678i, 0.012050765868053818 + 0.01956980455415258i, -0.008046629391497162 + 0.005885304387077855i, -0.00255029737908027 + -0.009335315375129565i }, { -0.03856542478051253 + 0.011450517154226384i, -0.008279604971694731 + 0.002598034505798023i, 0.12570000331089248 + 2.16840434497101e-19i, 0.024967018326755103 + 0.0002769355639345601i, 0.005709147087443535 + 1.1768901248132333e-05i, -0.0019400390357761713 + -0.0027156073280370455i, -0.014347449131410044 + -0.004204979108942749i, 0.0038687968112386083 + 0.011416416709285341i }, { -0.007791988583477511 + 0.0030432590519579006i, -0.04798999113907639 + 0.014986987255782722i, 0.024967018326755103 + -0.00027693556393455977i, 0.15461491478523523 + 6.5052130349130295e-19i, -0.004534758682375047 + 0.00612128612566794i, -0.00714345924868141 + -0.006548714141190538i, 0.02531305601359977 + -0.019627829378655447i, 0.0159943759365615 + 0.026087303994526585i }, { -0.011161780212710444 + 0.0037116526879385253i, 0.017088301563320293 + 0.014889827322563678i, 0.005709147087443537 + -1.1768901248132877e-05i, -0.004534758682375047 + -0.0061212861256679406i, 0.10020849916079089 + -8.67361737988404e-19i, -0.011918977939805085 + 0.00602864608219443i, -0.04084669704884318 + -0.012412048909156495i, 0.005552310401861243 + 0.000711564645950337i }, { 0.0029435331436626455 + -0.008209947595620805i, 0.012050765868053818 + -0.01956980455415258i, -0.0019400390357761713 + 0.0027156073280370464i, -0.00714345924868141 + 0.006548714141190539i, -0.011918977939805085 + -0.00602864608219443i, 0.11808382117956073 + -6.5052130349130295e-19i, 0.005272501307281104 + 0.0052163922864655165i, -0.047987009086867365 + -0.014152045361923136i }, { 0.003662336203811933 + -0.0034486410968877328i, -0.008046629391497162 + -0.005885304387077853i, -0.014347449131410044 + 0.00420497910894275i, 0.02531305601359977 + 0.019627829378655447i, -0.04084669704884318 + 0.012412048909156495i, 0.005272501307281104 + -0.0052163922864655165i, 0.13240050187732572 + 6.5052130349130295e-19i, -0.013848978825869072 + 0.00884800751908267i }, { -0.0006758990409742603 + 0.0037344653613903527i, -0.0025502973790802693 + 0.009335315375129565i, 0.0038687968112386083 + -0.011416416709285343i, 0.0159943759365615 + -0.026087303994526585i, 0.005552310401861243 + -0.000711564645950337i, -0.047987009086867365 + 0.014152045361923138i, -0.013848978825869072 + -0.00884800751908267i, 0.15657891162549933 + 6.5052130349130295e-19i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({false, true, false, false, true, true}), ElementsAreArray({ DoubleNear(0.09488169763934465, 1.0e-7), DoubleNear(0.11753165042135133, 1.0e-7), DoubleNear(0.12570000331089248, 1.0e-7), DoubleNear(0.15461491478523523, 1.0e-7), DoubleNear(0.10020849916079089, 1.0e-7), DoubleNear(0.11808382117956073, 1.0e-7), DoubleNear(0.13240050187732572, 1.0e-7), DoubleNear(0.15657891162549933, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({false, false, true, true, true, false}), Matrix({ { 0.4307056684010476 + -2.16840434497101e-18i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, -0.17538912205529947 + -0.05300159868108873i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { -0.17538912205529947 + 0.05300159868108874i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.5692943315989528 + 2.1684043449710096e-18i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({false, false, true, true, true, false}), ElementsAreArray({ DoubleNear(0.4307056684010476, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.5692943315989528, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({false, false, true, true, false, true}), Matrix({ { 0.49272826615682375 + 2.16840434497101e-19i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0025359124604948293 + 0.0377404767517979i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0025359124604948293 + -0.0377404767517979i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.5072717338431767 + -2.168404344971011e-19i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({false, false, true, true, false, true}), ElementsAreArray({ DoubleNear(0.49272826615682375, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.5072717338431767, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.0, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({false, false, true, false, true, true}), Matrix({ { 0.21241334806069598 + -6.5052130349130295e-19i, 0.0 + 0.0i, -0.08655541591958893 + -0.0264375044100091i, 0.0 + 0.0i, 0.0008889856553433734 + 0.015858151866214056i, 0.0 + 0.0i, 0.0011120388247316633 + -0.005886674278241833i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { -0.08655541591958893 + 0.026437504410009104i, 0.0 + 0.0i, 0.28031491809612774 + 8.67361737988404e-19i, 0.0 + 0.0i, -0.0014343121612378747 + -0.006536945239942406i, 0.0 + 0.0i, 0.0016469268051514559 + 0.021882324885583837i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0008889856553433734 + -0.015858151866214056i, 0.0 + 0.0i, -0.001434312161237873 + 0.006536945239942406i, 0.0 + 0.0i, 0.21829232034035162 + -1.517883041479707e-18i, 0.0 + 0.0i, -0.08883370613571054 + -0.02656409427107963i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0011120388247316637 + 0.005886674278241832i, 0.0 + 0.0i, 0.0016469268051514559 + -0.021882324885583837i, 0.0 + 0.0i, -0.08883370613571054 + 0.026564094271079634i, 0.0 + 0.0i, 0.2889794135028251 + 1.3010426069826059e-18i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({false, false, true, false, true, true}), ElementsAreArray({ DoubleNear(0.21241334806069598, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.28031491809612774, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.21829232034035162, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.2889794135028251, 1.0e-7), DoubleNear(0.0, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({false, false, false, true, true, true}), Matrix({ { 0.21241334806069598 + -6.5052130349130295e-19i, 0.0 + 0.0i, -0.08655541591958893 + -0.0264375044100091i, 0.0 + 0.0i, 0.0008889856553433734 + 0.015858151866214056i, 0.0 + 0.0i, 0.0011120388247316633 + -0.005886674278241833i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { -0.08655541591958893 + 0.026437504410009104i, 0.0 + 0.0i, 0.28031491809612774 + 8.67361737988404e-19i, 0.0 + 0.0i, -0.0014343121612378747 + -0.006536945239942406i, 0.0 + 0.0i, 0.0016469268051514559 + 0.021882324885583837i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0008889856553433734 + -0.015858151866214056i, 0.0 + 0.0i, -0.001434312161237873 + 0.006536945239942406i, 0.0 + 0.0i, 0.21829232034035162 + -1.517883041479707e-18i, 0.0 + 0.0i, -0.08883370613571054 + -0.02656409427107963i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.0011120388247316637 + 0.005886674278241832i, 0.0 + 0.0i, 0.0016469268051514559 + -0.021882324885583837i, 0.0 + 0.0i, -0.08883370613571054 + 0.026564094271079634i, 0.0 + 0.0i, 0.2889794135028251 + 1.3010426069826059e-18i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({false, false, false, true, true, true}), ElementsAreArray({ DoubleNear(0.21241334806069598, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.28031491809612774, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.21829232034035162, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.2889794135028251, 1.0e-7), DoubleNear(0.0, 1.0e-7) }));


}
}

}
