#include "gtest/gtest.h"
#include "gmock/gmock.h"
#include <chrono>
#include <iostream>

#include "superpositeur/Circuit.hpp"
#include "superpositeur/DefaultOperations.hpp"

namespace superpositeur {

using namespace std::complex_literals;

using testing::ElementsAreArray;
using testing::DoubleNear;

namespace {
Circuit randomCircuit() {

    Circuit c;
    c.addInstruction(CircuitInstruction({ Matrix({ { 0.1293494568963709 + -0.1041513084048281i, 0.030778523147866006 + -0.01707295631959447i, 0.07068243023750784 + -0.04876410980080859i, 0.13488127140540862 + 0.022536943733456934i }, { -0.05539881055479916 + -0.012933303375674927i, 0.022092651112451185 + 0.009153143945784334i, -0.0383235833549907 + 0.021913212082188327i, 0.05309465613660994 + 0.03292789145917947i }, { 0.08778603346367772 + 0.0646140924141007i, -0.1841040538083514 + -0.018841259134259002i, -0.10490143572260985 + -0.02491454923808634i, 0.11119778564537046 + 0.027279060683856635i }, { -0.09292533337647488 + 0.19969232288601796i, 0.05100915909579243 + -0.09488544303857624i, 0.10833778265609129 + -0.08896451752943407i, 0.19374240196483877 + -0.13491795570861007i } }), Matrix({ { 0.05974574702481079 + 0.052922365582885184i, 0.1820058697759883 + -0.038776208826920226i, -0.11322976197467874 + -0.08993176635491061i, -0.009467002193580236 + -0.034025515910430175i }, { 0.01498533806593585 + 0.22228616520516098i, -0.16935432759388216 + 0.18332226800665705i, 0.06884242434056723 + 0.15682317036628038i, -0.14837406429319228 + -0.015285939447394817i }, { -0.12748934042383286 + 0.009338729106060305i, -0.11585192990653001 + -0.020801339862941966i, -0.013937832290625328 + 0.0037584171112636767i, -0.09552791687365404 + -0.008037030176792467i }, { 0.04692824742929868 + 0.07376922483467489i, -0.07382706789057483 + 0.02210595128471489i, -0.01787333911097664 + 0.19226254912300778i, -0.09972801083494919 + -0.03900144167768284i } }), Matrix({ { 0.012171139844062632 + 0.002528201002683485i, 0.023038477585955414 + 0.03069215417673039i, 0.06032242112549586 + 0.02537210047116556i, 0.0724030118139751 + -0.1634912327053226i }, { -0.02814553496291842 + -0.036601398296878626i, -0.04567427052037254 + -0.13510600132564923i, 0.04941669706867578 + -0.10726395133775046i, -0.08989733081586129 + 0.028371057186493066i }, { -0.050004359567314395 + 0.057079380030025446i, -0.013536928173713004 + -0.05599666809180834i, 0.07312552808360386 + 0.16480674337898413i, 0.044988066298873884 + -0.020512593456175815i }, { -0.07485562957675568 + 0.09743092560748923i, -0.014937044275202567 + -0.021725732482936102i, -0.05321036447231464 + 0.03049325187574377i, -0.0885665990389326 + 0.07214195363565523i } }), Matrix({ { 0.12359698864864102 + 0.09237298954968169i, 0.03273068372441752 + 0.04210076207990684i, -0.05133102763111321 + -0.028252693811569602i, 0.10549508534830741 + -0.19549803132389632i }, { 0.09023796086483542 + -0.03843169348405406i, 0.06362254636125597 + -0.16818104313714766i, -0.09273997463586049 + 0.029714668036092448i, -0.04278390255834467 + 0.02593740064100309i }, { -0.06692082782872859 + 0.060556754805610416i, 0.06313198918951277 + -0.059823532936783i, 0.0476459333848929 + 0.06019866210005595i, 0.04459953590687945 + -0.017082129893520634i }, { -0.13618351429099723 + 0.07065394714369536i, 0.10986905224155463 + -0.015096843295084874i, 0.10026411037629453 + 0.19937804516443028i, -0.10591599966202714 + 0.03748078432332018i } }), Matrix({ { 0.016053556814585347 + 0.03741612153672243i, 0.08377588587741952 + -0.0020390581019570403i, 0.03923829652552082 + 0.07894019205470515i, -0.04572278597908003 + 0.05284441742363756i }, { -0.0789438196924765 + -0.0758080924590828i, -0.08795948027939267 + 0.043894033819843796i, -0.01664155393963105 + -0.05159872101975092i, -0.01895991844025323 + -0.033124120293730346i }, { 0.10441800725237668 + 0.006966521699132162i, 0.04392009071791646 + 0.0024747241130809324i, -0.08974688489814125 + 0.051521922857747746i, 0.08318383309076346 + -0.03912561402438399i }, { 0.16203003389485174 + -0.031484609742420504i, 0.0320084964521668 + 0.02145850270978344i, -0.03349553683560241 + 0.11802106773575284i, 0.09083304731392215 + 0.0350697457103167i } }), Matrix({ { -0.16391756978568667 + -0.051982304596626006i, 0.09354035648031404 + 0.0390505835236114i, -0.02385139184314106 + -0.004127896514673217i, 0.12320342292068509 + -0.026222335459101964i }, { 0.1322256263989862 + 0.055108919839351456i, -0.05516921227174492 + -0.12923155740407527i, -0.039726706250947375 + 0.0025787568913453623i, 0.01099127726236546 + 0.025978749940018805i }, { 0.0894638568937182 + 0.012537474473133359i, -0.02851135901924364 + 0.013716843864192241i, -0.052264226546234964 + 0.1546834972633451i, 0.08927307729939259 + 0.11637883162723323i }, { -0.030389528468740906 + 0.0334191687615087i, 0.09523862227857739 + 0.0013784530441572909i, -0.07157116776711706 + 0.03261282817910965i, 0.18710712917406408 + -0.1315424144751989i } }), Matrix({ { 0.18554026049448336 + 0.04378522621060677i, -0.006414152410258346 + 0.0962719552443817i, -0.03104259874593971 + 0.0007611398529794695i, 0.17200529653817165 + -0.2553717556199353i }, { -0.06781023829016927 + -0.031062478137047617i, -0.02818281789779121 + -0.01033831008160744i, 0.1188058976261292 + 0.06123486175513263i, 0.06566649498609221 + -0.09166762981209609i }, { 0.1289417730001866 + -0.006353150327106522i, -0.06285335556495424 + 0.10775032981927338i, 0.050369356202947926 + -0.09845970512515385i, 0.0759124693028459 + 0.00791589594504267i }, { 0.09129569858912823 + 0.005623581671054673i, -0.11505130674780117 + -0.09740012594694274i, 0.14377359514569202 + -0.048051958075257625i, 0.008562376089446927 + 0.17582833544487755i } }), Matrix({ { 0.07670549275277705 + -0.05195203455525537i, 0.03053190637069316 + 0.018043914351432638i, 0.00937345915728272 + 0.09213455095405004i, 0.020052007268997647 + -0.056186840841968365i }, { 0.06089400751996327 + 0.07948670930891306i, -0.02284538207495669 + -0.03403006762031169i, -0.05612882248153586 + -0.056974600933594514i, -0.002264069468658295 + -0.05938819524495822i }, { -0.05105457163822672 + -0.10587564662335537i, -0.10972831275532072 + -0.08852889395208748i, 0.18097752504226797 + 0.03974446850005726i, -0.12245930877403294 + -0.07012201641108805i }, { 0.06213085104016106 + 0.17762447957728808i, 0.15714020740149937 + -0.06561620369244182i, -0.25561778627156884 + 0.12943808397382356i, 0.01125885853030715 + 0.01753017963144842i } }), Matrix({ { 0.12322866987753277 + 0.21640952692761287i, -0.012450974684444652 + 0.05011693992124968i, 0.03470426026274905 + 0.1438709480443465i, -0.19140133053861677 + -0.0038598672048461486i }, { 0.05604618512784286 + -0.2539675795819191i, -0.04627235127785688 + -0.0028356948073273i, -0.1494045141647404 + -0.06468876650502366i, -0.06948273017734292 + -0.06079455605152382i }, { -0.14393095205638376 + -0.010187294489639323i, 0.026942581936128016 + 0.1826131992072157i, 0.08247458498584455 + 0.026597318995617753i, -0.08250390990339437 + 0.049114007823368555i }, { -0.026702792756904917 + -0.09934412275555077i, 0.02076633599321809 + 0.036023849567500946i, 0.027205992306783233 + 0.23839482811017076i, 0.1492474501850888 + 0.05324644110629952i } }), Matrix({ { -0.024504039622866028 + 0.043575404400559584i, 0.2524171326368155 + -0.10381865830808745i, 0.1296807473656585 + 0.035439899033672645i, -0.046114766533545404 + -0.022601057819769347i }, { 0.023422897194164582 + -0.0583245971061489i, -0.17358935992443425 + -0.1948455362195956i, 0.015584971416978287 + -0.08758751585181536i, 0.1882557890536734 + -0.08269719326069314i }, { -0.07741174353191836 + -0.004415624857633503i, 0.08911519396418026 + 0.07811027410140668i, -0.0023930173338595185 + -0.015322710539199647i, 0.014880556513897105 + -0.03357387184716126i }, { -0.03349924256929637 + -0.040805673738469335i, 0.03407721292472738 + 0.012418508907110952i, 0.010913179041290109 + 0.15136483841922366i, 0.008799269179211736 + -0.0531973546567793i } }), Matrix({ { 0.06173548858694582 + -0.008792863689189842i, 0.16595367055656995 + -0.07750224119345048i, -0.0424396306152255 + 0.036953731478696204i, -0.1021254077378336 + 0.028594351288597063i }, { -0.08204712607887094 + 0.007716914654474851i, 0.008359690021806962 + -0.03225347762802275i, 0.03820608747776861 + 0.06296148674056995i, -0.06426173516915094 + 0.18795307547947218i }, { 0.048224542019251825 + -0.09198214103391218i, 0.13106286272172346 + 0.06876313085417392i, -0.024256816333483835 + -0.18783707915496412i, 0.03757471848446746 + -0.11922961822566518i }, { -0.0384962546460487 + -0.024541848155948197i, -0.07046505705080217 + -0.03621858988097258i, 0.037616036640947696 + 0.0406940434963114i, 0.06300444424063154 + -0.0747148244859505i } }), Matrix({ { -0.05774901652751388 + 0.18169248041832103i, -0.022441833902000004 + 0.09773120921530942i, -0.019199427814008116 + -0.017546293696918767i, 0.08368282118498892 + -0.006707046231383328i }, { 0.07870629465928801 + 0.046471282616339656i, 0.04458841311498367 + 0.11583962436162683i, -0.03541815316804481 + -0.02403762223370864i, 0.016348192690347794 + 0.1508014666479883i }, { 0.058531466597760026 + -0.0486412260520917i, -0.009886516551699505 + 0.015184017548906954i, 0.07820363546607548 + -0.16991521969496307i, 0.029019982287224175 + 0.06139421776632266i }, { 0.0900851451485565 + -0.10432735645027344i, 0.06640899367113978 + 0.19186911704613127i, -0.13850334471988496 + 0.12257099128270826i, 0.07516937227741764 + 0.18622233046641679i } }), Matrix({ { -0.15527931092391467 + 0.023914240568909804i, -0.0321696376588277 + -0.05668550173563746i, -0.014709880959115362 + 0.008066127621778517i, 0.08141330544898123 + 0.010105890736570516i }, { 0.13348914796044564 + -0.10189201073960247i, -0.06510647905429036 + -0.0409730059609437i, -0.0284332516549425 + 0.046543609295617086i, -0.023449172678053347 + -0.042163952152238136i }, { 0.021673361069834907 + 0.033270271395625786i, -0.016628625264017722 + -0.10536927002357006i, -0.1961900437290716 + 0.0025670521330580184i, 0.03016242144761361 + 0.1023785920953491i }, { 0.04427461241421089 + -0.12413719556188159i, 0.11896381427672872 + -0.10168493133099267i, 0.04410083602336822 + 0.015413825046124775i, -0.016685011675217725 + 0.04399449241495721i } }), Matrix({ { -0.1398667693753686 + 0.0003477728508943477i, 0.07629112351150791 + -0.033940750130930314i, -0.024354046451318508 + -0.16028173626359324i, 0.02684255527133815 + 0.09204375116720853i }, { -0.05647129541604897 + 0.14811010590918147i, -0.06674896622990657 + -0.1406330003037344i, -0.026291780958999717 + 0.059377652185314045i, 0.09288700800220842 + -0.07858179954773711i }, { 0.07372288126857654 + 0.0021293494146769707i, 0.10177295864144394 + -0.07223858862994366i, -0.11685605878585466 + 0.09610171429056309i, -0.08859036303585548 + 0.06359272126690776i }, { -0.02369007496844617 + 0.02008336001235052i, 0.025569222052210776 + 0.07739393426659322i, 0.1753403946619488 + 0.1116937767842116i, 0.040756262502051284 + -0.028562693456393i } }), Matrix({ { 0.0736312410724477 + -0.103932013815992i, 0.03617751523099783 + -0.06086900433177567i, 0.06754765879187727 + -0.12573693126236807i, -0.06422749285408784 + -0.06319738742329577i }, { -0.10859327016020219 + -0.008599807659492842i, -0.015484401722318256 + 0.10325075913939476i, -0.04743511364539626 + 0.09658516305939205i, 0.1213473877325486 + -0.1577827611338039i }, { -0.08097759132498901 + 0.12465511056858361i, 0.04536263075617828 + -0.10341191275999916i, -0.025986326082523006 + -0.04314354958328385i, 0.05575582812529308 + 0.12315297883452243i }, { -0.13097676430020272 + 0.07222800164912521i, -0.0586595851981387 + 0.14170408391157124i, 0.060453667571141984 + -0.054766995643588355i, 0.026547185056700055 + -0.13503086901515152i } }), Matrix({ { -0.09759978808646688 + 0.025027480364693558i, 0.17196015494385677 + 0.07110010552221205i, 0.02741939334003958 + 0.05236579317094777i, 0.02189842994193323 + 0.02408232930293526i }, { -0.051727914479379036 + 0.012533034827233953i, -0.08792675673721312 + -0.14093510330607845i, -0.09453951309853499 + 0.06117779678679949i, -0.03306068049630085 + 0.012958375270661699i }, { -0.05778229138628755 + -0.07478399856392458i, -0.05816384179869067 + -0.0686470599089355i, -0.0695926069850822 + -0.04323826993420989i, -0.1151522383422972 + 6.985724549185528e-05i }, { 0.011027126282372807 + 0.08229596980884564i, -0.1979152309801465 + -0.06850563884640358i, 0.06805776585937542 + 0.02078628203330911i, -0.11678583458751612 + -0.0023893938748834674i } }) }, { QubitIndex{ 0 }, QubitIndex{ 1 } }));

    c.addInstruction(CircuitInstruction({ default_operations::CNOT }, { QubitIndex{ 2 }, QubitIndex{ 0 } }));

    c.addInstruction(CircuitInstruction({ Matrix({ { 0.018063500298508783 + 0.11708925303719452i, 0.3572626321905078 + 0.5595338375193861i }, { -0.3953325598374255 + 0.3017114250301019i, 0.06617465375534815 + 0.05118536151175136i } }), Matrix({ { -0.22913454736262745 + 0.17130921480134598i, 0.0638077025623015 + 0.32096278946876167i }, { 0.09339939976966623 + 0.004166662594830159i, 0.1778713696401228 + 0.02553443197860561i } }), Matrix({ { -0.13065172313958245 + -0.1257947190202827i, 0.4612005415156279 + -0.014974907564941492i }, { -0.407484560186954 + -0.4096686732231005i, 0.1388877759019214 + 0.1682858338964549i } }), Matrix({ { 0.21369563572286948 + -0.029736228862346097i, 0.0788683398114747 + -0.209701174609961i }, { 0.22268125433360678 + -0.4302936454608639i, 0.3132944747126361 + 0.06339680366913357i } }) }, { QubitIndex{ 2 } }));

    c.addInstruction(CircuitInstruction({ Matrix({ { 0.05380202540759549 + 0.04084745680903851i, 0.10329096162079253 + -0.028957943623247533i, -0.026286126423393348 + -0.06132541492070546i, 0.08644280073243175 + -0.03378165455709969i }, { -0.023069808938289516 + 0.05758813676238517i, -0.019054692415643504 + 0.026595814071536866i, 0.031047334523624858 + -0.017858484222107705i, -0.18251823408042495 + 0.01386783437027642i }, { 0.006362910256221264 + -0.017700864980810253i, -0.017399133933190328 + -0.1822786300642589i, 0.16255758169792595 + 0.03206997924486604i, -0.009178181124357459 + -0.08414574726398401i }, { -0.07410697265987524 + -0.09085774460177357i, -0.2052001616094007 + 0.03000786464216306i, 0.06428984336555271 + 0.0985935374927688i, -0.14063325936942261 + 0.04163465040312157i } }), Matrix({ { 0.044221783535279974 + -0.18128921634343376i, -0.09818150222540488 + 0.06561052930125988i, -0.11494600283377156 + 0.0841523441862046i, -0.05498654998848878 + 0.15237903061014738i }, { -0.03315409990650798 + 0.07203901122470947i, -0.07469667709697722 + 0.11611669543138224i, -0.0005447562826939491 + 0.2388547872170818i, -0.012084710782180163 + -0.019200636738078515i }, { -0.04560800238491841 + 0.20602963420718626i, 0.16811617734813 + 0.03736195715454746i, -0.0034052335127124867 + 0.1548045840285959i, 0.011653533152314469 + -0.06657253219060966i }, { -0.10535404286989931 + -0.10257491256158183i, -0.14544128729527847 + 0.22787012749165259i, 0.06454166854019382 + 0.0011841882425262578i, 0.03981672093123493 + -0.20754347804344608i } }), Matrix({ { 0.053405669575372516 + -0.031001095426524093i, 0.010334174031411302 + -0.05402533784587488i, 0.031682482219842295 + 0.05473283438750813i, -0.003832293585589862 + -0.19534619095760117i }, { -0.0750131512039997 + 0.08162061683525634i, -0.21282952645672001 + -0.046878819611589864i, -0.031809231270254146 + -0.11036340204065476i, 0.028682738162695728 + 0.12163034050482159i }, { 0.07575078864732987 + -2.0869809384719152e-05i, 0.012040018482528177 + 0.025305230716594112i, -0.045672912127603264 + 0.023551762418543933i, 0.1267759320881906 + 0.032347088358219644i }, { 0.029986002032907504 + 0.0887890234993221i, -0.03223642915921018 + -0.035632149357700496i, -0.0526397731254057 + 0.050441856563186095i, 0.07557817571153291 + 0.004800591510583713i } }), Matrix({ { -0.07520926331353997 + 0.023068366937019143i, -0.12957931216415136 + -0.01419391509740279i, -0.05449345759916509 + -0.05858412054213865i, -0.13041621796332933 + -0.061747796987007796i }, { 0.04552388240315549 + 0.05535126105173232i, -0.004655569348281336 + 0.0004981647431287234i, 0.20645760116595535 + 0.028292758208645567i, 0.01683913405226234 + 0.08019612671858924i }, { 0.23284038651754274 + -0.002270497938996823i, 0.023851892447673585 + -0.017839404415214814i, -0.15438028831353542 + 0.07441762810415452i, -0.02418713006400398 + -0.0016121476135249181i }, { 0.1263384766779739 + 0.01679521096754425i, 0.07684603572115198 + 0.07304807537981967i, -0.006590975043587485 + 0.17082379372330148i, -0.10704502486188282 + 0.07151176516765849i } }), Matrix({ { -0.05345429090428701 + -0.02631398712237817i, 0.0459595254111033 + -0.02741987396857304i, -0.03896462849629375 + 0.1718415863603676i, 0.035336643548368386 + -0.09011491971096418i }, { 0.0060138767735803626 + -0.07074004180402636i, 0.02831243702093587 + -0.023015463736974398i, 0.034840056220339206 + 0.0838123246297119i, 0.022840523405202234 + 0.00076094322325063i }, { 0.0656551091444869 + -0.07517977804253263i, 0.0043752707110151215 + -0.11536003805923264i, -0.15054538526599043 + 0.1516030449514934i, -0.11060269866683858 + 0.07848905268716215i }, { -0.07990167538645826 + -0.04385007695088449i, -0.1640244313055467 + 0.05727665228808968i, 0.04428297394677053 + -0.11540572556199499i, 0.08627072249941743 + 0.1374254710800909i } }), Matrix({ { 0.016006673680470887 + -0.03578834628115825i, -0.11589526520888098 + 0.01618515267611447i, 0.016479645235583037 + -0.011033493870157528i, -0.01781367077209394 + -0.10069079822430009i }, { -0.07471524717827195 + -0.10601491757347052i, -0.17525194744431788 + -0.06620039919140687i, 0.06633916528452426 + 0.05614672065549223i, 0.07997220480027004 + -0.012131504365915322i }, { -0.06088135158030549 + -0.2545425933012154i, 0.032267487774650876 + -0.01600070048673634i, -0.09036526356299177 + -0.15311645701287852i, -0.09533667488713254 + -0.06905984964280382i }, { -0.01907339377467937 + 0.0071615075088735615i, -0.00625680869108574 + 0.10773181428740616i, 0.16133726457685266 + -0.04110934562485706i, 0.05899288854473738 + -0.09040002064996701i } }), Matrix({ { 0.11154582507423988 + 0.02425907519580958i, 0.029406087855356863 + 0.04007724401393574i, -0.08115938359444277 + -0.06609760500710564i, -0.07747699896372735 + -0.11186417010134692i }, { 0.0649600695590038 + -0.0634760730535665i, -0.11336348930549794 + -0.09881369726296181i, 0.07856505434764337 + 0.029193937152428087i, -0.14018105666188055 + -0.16996527531072048i }, { 0.12326860143298861 + -0.022528295408304103i, -0.07738780850514304 + 0.08716183235270426i, -0.2142745576137475 + 0.07583518344451183i, 0.08921337790046444 + 0.07184491821062766i }, { 0.007427842843508918 + 0.2807164158757378i, -0.03481483435447309 + 0.030235476542005427i, 0.03269850786081522 + -0.04834109078865315i, 0.08735286311961937 + -0.11996922902995613i } }), Matrix({ { 0.012812342546518194 + 0.0661720055682103i, -0.08275543690167637 + 0.03064604383394435i, 0.009724681227281123 + 0.018122463797935015i, 0.029458632166392277 + -0.12563068359386184i }, { 0.15735391165791618 + 0.04116463475368456i, -0.10447629583314659 + 0.12344164736969691i, 0.01583793626336219 + 0.0010588177424716426i, -0.043793228737299086 + 0.12474151527195401i }, { 0.07599701882820674 + 0.08711539309402286i, 0.009854246446778153 + 0.03940050970067443i, -0.149233871598358 + -0.029621099749561272i, 0.03811529847753239 + -0.05940015740808584i }, { -0.00773961041934381 + -0.17098578685898397i, 0.1143959070436923 + -0.05134487416818071i, -0.015905438929396415 + -0.11496832332314941i, -0.05716967145630095 + -0.15875088030016987i } }), Matrix({ { 0.12164608803607214 + 0.029100242248359453i, 0.05038800208650161 + 0.017004976436158076i, 0.09612799370993318 + -0.03364698879686146i, 0.029346096385698767 + -0.06969597247563826i }, { 0.16971394518714508 + -0.03570956792817981i, -0.10210383032871793 + -0.027286327103071786i, 0.05499152154107658 + -0.004948237056371915i, 0.09776175890245851 + 0.07741447787385984i }, { 0.027569601277040154 + -0.00732096825111834i, -0.08500812283677163 + -0.05640647428421847i, 0.018940126505372776 + -0.028913756208779097i, 0.019262904882762277 + 0.1615508298481254i }, { -0.10744642443282579 + -0.08741493997294958i, 0.13363114010082003 + 0.07149350570097716i, -0.0386952340331836 + -0.017295921855329327i, -0.07592952347830638 + 0.040522315941538455i } }), Matrix({ { 0.06028672779917348 + 0.021865317552937427i, -0.13768183333166303 + 0.1252718415763604i, 0.04805963744651902 + -0.09590376300806633i, -0.13470686065437745 + -0.012376244450337194i }, { -0.06606802486369116 + -0.12124492302147961i, 0.1817771139156276 + -0.021633902385690504i, -0.03243233090204679 + 0.03721389120332993i, -0.009114401340344969 + 0.002915116405761667i }, { 0.031531014745227674 + 0.05743905793323732i, -0.030525756277565142 + -0.06087095283568719i, 0.027689111533350345 + -0.00952011677094366i, 0.19681518870084824 + -0.02564337783153947i }, { 0.010630408753459332 + 0.09598079925811809i, 0.003328215065582511 + -0.11127997115888397i, -0.056280573516072 + -0.007702667768543131i, 0.08459856072196867 + -0.18151192642445377i } }), Matrix({ { 0.014063527190348092 + -0.0562824980337292i, 0.0850769087013184 + 0.08943056436877528i, 0.0661800954415017 + 0.23667732271073405i, -0.18472872692941966 + -0.08179191352807286i }, { -0.11853867229203849 + -0.009716370362265324i, 0.16894144954637935 + 0.0029493372884483384i, 0.03149480205197031 + -0.06568662825526664i, 0.04919180384150811 + 0.05711012989627405i }, { -0.07781362480185529 + 0.005802278383832135i, 0.00655062378145738 + -0.07392492111343708i, -0.025443150012928045 + -0.0028504936415742746i, 0.058125513919045524 + -0.002236357347360416i }, { 0.026724766942892417 + 0.12717485026703457i, -0.03487515033509583 + -0.10606154661951693i, -0.03837984718922336 + -0.09052821902037073i, -0.019781745443197322 + 0.037091064879944034i } }), Matrix({ { 0.09312438320150514 + 0.1347105489730296i, -0.0029885848710594293 + 0.10353989352519423i, -0.07243965804684427 + 0.04359426360853032i, 0.0509658479581917 + 0.14075239866313882i }, { 0.07562122793996344 + 0.12158382314119281i, -0.050994328310029806 + 0.08913499888392874i, 0.060390167049858896 + 0.04983209372465991i, -0.012253573506440586 + -0.004735932439238443i }, { -0.05184482235103109 + -0.05548589589186983i, -0.0145321331074004 + 0.06142358736882038i, -0.15674610946808296 + 0.05056505211654717i, -0.05659829049520229 + -0.1415080091618677i }, { 0.1643972532774206 + -0.05999142241809197i, 0.13261026128082531 + -0.024407901279887817i, 0.020242047013593015 + -0.14879101057520974i, 0.11043536637183035 + 0.072114695556466i } }), Matrix({ { 0.16045858477879552 + -0.03720405246892613i, -0.05528923610617254 + -0.1608608256204626i, -0.10207085687256 + -0.015496236816786007i, 0.04080676333689792 + 0.025721225299961445i }, { -0.04280497725865353 + 0.03154494742911675i, 0.21745697952078413 + -0.012164581426869483i, 0.0034400006730144705 + 0.16974152607954734i, -0.024929534853929045 + -0.06898849940680984i }, { -0.0693140542864017 + 0.016770190357348898i, 0.12967450121926985 + -0.09322235805637011i, -0.12466040599720378 + -0.043797352345258i, 0.06299706838537421 + 0.1155846300864865i }, { 0.019324540931865874 + 0.08839364434827066i, -0.07967676480280408 + -0.03192042894517109i, 0.0361413131548558 + 0.08400143738754952i, 0.07948495766187642 + -0.020270101424290546i } }), Matrix({ { 0.08777466731214728 + 0.06273408284966861i, -0.04646926858865256 + -0.1079154747897171i, 0.1163823842122857 + 0.049631827273106284i, 0.044710620479585066 + -0.06542469274998404i }, { -0.03072207737965399 + 0.15764795078923738i, -0.06271500302568818 + -0.0694160885276152i, -0.06393297108507989 + -0.03679949564117i, -0.09298127256933826 + -0.1355567899365775i }, { 0.06383783657595736 + -0.05201607112683458i, 0.01819747003544375 + -0.10361668634989571i, 0.0760262424071196 + -0.051922113412013554i, -0.08029909592262507 + 0.0689582893415608i }, { -0.07390613089886504 + 0.16424780944162762i, -0.026707353472424367 + 0.03128306242811889i, -0.06951552715476123 + 0.026659532791613854i, -0.050494708692058514 + 0.09253107187403503i } }), Matrix({ { 0.011481103276174492 + 0.030815860576432725i, 0.04945762069773126 + -0.14764432328706095i, 0.023979042910561483 + -0.09602843308256483i, -0.051694833776201925 + 0.17426383056479905i }, { 0.17920948909806514 + 0.032038051744895026i, -0.0801965749410875 + -0.08015620297126774i, 0.04485074628171281 + 0.08041074449921602i, -0.04974788304206195 + 0.04440443643455857i }, { 0.021283016545007943 + -0.09799470620197964i, -0.01259562577435461 + 0.02902342276149395i, -0.15635010878404204 + -0.1370629254802347i, 0.03080997922466555 + -0.050995287933326014i }, { -0.08165055615699028 + 0.052397978233208235i, -0.07395824186568292 + -0.05772577729999733i, 0.032890408104209415 + 0.043702991617314696i, 0.010390122637904503 + -0.1660375963006536i } }), Matrix({ { 0.15702684431532243 + -0.09440098504233596i, 0.05922481215889401 + 0.01757345082065974i, -0.08572129388292563 + 0.15394305532628083i, 0.028116673000497423 + 0.13879667570580556i }, { -0.024609038649585465 + -0.04996117085339186i, 0.02668574518589576 + 0.0017814031209919233i, 0.06658785665698581 + 0.00744300132198274i, 0.07009536548346912 + -0.004727970289616765i }, { 0.01668883247760942 + 0.04227095196037007i, 0.14862064238188727 + 0.13970940818713412i, 0.0418246724206015 + -0.14009832277613615i, 0.030358429014419454 + -0.12114805679791942i }, { 0.12132099887488211 + 0.020808976411732665i, 0.08736417585717828 + 0.08852164165636181i, 0.1857906117405053 + -0.07709691107117041i, 0.0022221304776465175 + -0.02005895497197536i } }) }, { QubitIndex{ 0 }, QubitIndex{ 1 } }));


    return c;
}

TEST(RandomizedIntegrationTests, 3_4_2_100_30_20) {
    auto c = randomCircuit();
    
    auto s = c.execute();

    EXPECT_EQ(s.getReducedDensityMatrix({true, false, false}), Matrix({ { 0.49316790664664123 + 0.0i, -0.03411954184979361 + 0.061722685848278544i }, { -0.034119541849793614 + -0.06172268584827856i, 0.5068320933533583 + 1.0842021724855044e-18i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({true, false, false}), ElementsAreArray({ DoubleNear(0.49316790664664123, 1.0e-7), DoubleNear(0.5068320933533583, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({false, true, false}), Matrix({ { 0.483138864094937 + 0.0i, 0.008541205875924454 + 0.06065141437971047i }, { 0.008541205875924452 + -0.060651414379710465i, 0.5168611359050626 + 1.0842021724855044e-18i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({false, true, false}), ElementsAreArray({ DoubleNear(0.483138864094937, 1.0e-7), DoubleNear(0.5168611359050626, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({false, false, true}), Matrix({ { 0.17532992321746133 + 2.168404344971009e-19i, 0.1726528721927634 + 0.04828140668936544i }, { 0.1726528721927634 + -0.04828140668936544i, 0.8246700767825383 + 8.673617379884035e-19i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({false, false, true}), ElementsAreArray({ DoubleNear(0.17532992321746133, 1.0e-7), DoubleNear(0.8246700767825383, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({true, true, false}), Matrix({ { 0.24644421687419768 + 0.0i, -0.031556170055246406 + 0.016104952752379977i, 0.012531708298486328 + 0.04541614656118349i, -0.03135631880399483 + -0.02694084633685558i }, { -0.031556170055246406 + -0.016104952752379977i, 0.23669464722073935 + 0.0i, 0.011147602019145803 + -0.020131347134458764i, -0.003990502422561876 + 0.015235267818526979i }, { 0.012531708298486332 + -0.045416146561183486i, 0.011147602019145808 + 0.020131347134458768i, 0.24672368977244358 + 0.0i, -0.0025633717945472033 + 0.04561773309589857i }, { -0.03135631880399483 + 0.026940846336855576i, -0.003990502422561879 + -0.01523526781852698i, -0.0025633717945472067 + -0.045617733095898574i, 0.27013744613261903 + 1.0842021724855044e-18i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({true, true, false}), ElementsAreArray({ DoubleNear(0.24644421687419768, 1.0e-7), DoubleNear(0.23669464722073935, 1.0e-7), DoubleNear(0.24672368977244358, 1.0e-7), DoubleNear(0.27013744613261903, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({true, false, true}), Matrix({ { 0.08646709120567178 + 0.0i, -0.005982176652739275 + 0.010821833770554167i, 0.08514685555583526 + 0.023810840266949504i, -0.008870894995668737 + 0.009009259515052215i }, { -0.0059821766527392755 + -0.010821833770554169i, 0.08886283201178956 + 2.168404344971009e-19i, -0.0029107788008673812 + -0.012303938467261636i, 0.08750601663692817 + 0.02447056642241594i }, { 0.08514685555583526 + -0.023810840266949504i, -0.0029107788008673812 + 0.012303938467261634i, 0.4067008154409695 + 0.0i, -0.028137365197054332 + 0.05090085207772438i }, { -0.008870894995668737 + -0.009009259515052215i, 0.08750601663692816 + -0.02447056642241594i, -0.028137365197054336 + -0.050900852077724386i, 0.4179692613415688 + 8.673617379884035e-19i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({true, false, true}), ElementsAreArray({ DoubleNear(0.08646709120567178, 1.0e-7), DoubleNear(0.08886283201178956, 1.0e-7), DoubleNear(0.4067008154409695, 1.0e-7), DoubleNear(0.4179692613415688, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({false, true, true}), Matrix({ { 0.08470869994513683 + 0.0i, 0.0014975289704103642 + 0.010634007826225068i, 0.08341531255394008 + 0.023326623984805724i, -0.001453671877483965 + 0.010884022329723592i }, { 0.0014975289704103646 + -0.010634007826225068i, 0.09062122327232451 + 2.168404344971009e-19i, 0.0044029993304200935 + -0.010059259460697382i, 0.08923755963882332 + 0.024954782704559718i }, { 0.08341531255394008 + -0.02332662398480572i, 0.0044029993304200935 + 0.01005925946069738i, 0.3984301641498002 + 0.0i, 0.0070436769055140895 + 0.050017406553485404i }, { -0.0014536718774839645 + -0.010884022329723592i, 0.08923755963882332 + -0.024954782704559718i, 0.007043676905514088 + -0.0500174065534854i, 0.4262399126327381 + 8.673617379884035e-19i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({false, true, true}), ElementsAreArray({ DoubleNear(0.08470869994513683, 1.0e-7), DoubleNear(0.09062122327232451, 1.0e-7), DoubleNear(0.3984301641498002, 1.0e-7), DoubleNear(0.4262399126327381, 1.0e-7) }));


}
}

}
