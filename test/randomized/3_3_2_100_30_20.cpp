#include "gtest/gtest.h"
#include "gmock/gmock.h"
#include <chrono>
#include <iostream>

#include "superpositeur/Circuit.hpp"
#include "superpositeur/DefaultOperations.hpp"

namespace superpositeur {

using namespace std::complex_literals;

using testing::ElementsAreArray;
using testing::DoubleNear;

namespace {
Circuit randomCircuit() {

    Circuit c;
    c.addInstruction(CircuitInstruction({ Matrix({ { -0.2933943553069016 + 0.2515086668604285i, -0.2575249037023317 + -0.38854539994327747i }, { -0.20583015415661796 + -0.3828405818475315i, 0.33271047023670763 + 0.2219741305392806i } }), Matrix({ { 0.017008722407476015 + -0.06571454877284123i, 0.29327296130488895 + -0.06333757507542319i }, { 0.31737365050515814 + 0.21782489285716164i, 0.20472932990110637 + -0.09069889637436251i } }), Matrix({ { -0.2453209763296044 + 0.03130101723286656i, 0.24716857608542153 + 0.19122002054806478i }, { 0.3224280439259032 + -0.1465543396640389i, -0.20663711868063064 + 0.01044078077454845i } }), Matrix({ { 0.19515504862213615 + -0.2885836501690488i, 0.15132284540431265 + -0.05796320029097085i }, { -0.3383951972883703 + 0.29406000062960364i, -0.10471328050775153 + 0.5521730170170663i } }) }, { QubitIndex{ 1 } }));

    c.addInstruction(CircuitInstruction({ Matrix({ { 0.13279608923545805 + 0.11884347405514732i, 0.10152575936687518 + -0.0679401380065869i }, { 0.24770021014520435 + -0.3576061497112711i, 0.018588764668772736 + 0.14588861656563806i } }), Matrix({ { 0.18964604249110767 + -0.06064969449044728i, -0.1256789666129935 + 0.2355404267723445i }, { 0.19366955122872231 + -0.21585795516757664i, -0.3691385040431692 + -0.247603050349901i } }), Matrix({ { 0.290419731619781 + -0.34712373208699526i, 0.12241389848249543 + -0.0840589973354671i }, { 0.3896515799757424 + -0.053421702683396355i, 0.17496756913926836 + 0.5354068226955118i } }), Matrix({ { -0.4640106641236405 + -0.1765615449272633i, 0.008163123673442213 + 0.08226690939562487i }, { -0.17850462797516153 + 0.1318817668253566i, 0.30452340756554913 + 0.5056762263300326i } }) }, { QubitIndex{ 2 } }));

    c.addInstruction(CircuitInstruction({ Matrix({ { 0.06811178502506943 + -0.40932640241656437i, 0.01233428511114161 + -0.31101283377006667i }, { 0.23231277213372117 + -0.38605730961369455i, -0.32502412450652896 + 0.33842082416171027i } }), Matrix({ { 0.014371934722573882 + 0.018743104981200614i, 0.18157618777233733 + -0.41631070408789866i }, { 0.09186943417907048 + -0.3821688295265494i, 0.020729949317713783 + 0.07889458486557262i } }), Matrix({ { -0.17897633525924783 + -0.06643657607906295i, -0.024799634409399383 + 0.14679430370970306i }, { 0.01606351581466281 + -0.44910185084813337i, -0.3062124412607824 + 0.011353959784029803i } }), Matrix({ { 0.45253211186657377 + -0.12271932019034751i, 0.33787181207664513 + 0.31575115388078034i }, { 0.10660387620060224 + -0.012073131069824217i, 0.1569940396780604 + 0.33977802188796935i } }) }, { QubitIndex{ 1 } }));


    return c;
}

TEST(RandomizedIntegrationTests, 3_3_2_100_30_20) {
    auto c = randomCircuit();
    
    auto s = c.execute();

    EXPECT_EQ(s.getReducedDensityMatrix({true, false, false}), Matrix({ { 1.0 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({true, false, false}), ElementsAreArray({ DoubleNear(1.0, 1.0e-7), DoubleNear(0.0, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({false, true, false}), Matrix({ { 0.3269796988924939 + 0.0i, 0.044298680503343096 + -0.0016468646540780275i }, { 0.044298680503343096 + 0.0016468646540780275i, 0.6730203011075061 + 0.0i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({false, true, false}), ElementsAreArray({ DoubleNear(0.3269796988924939, 1.0e-7), DoubleNear(0.6730203011075061, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({false, false, true}), Matrix({ { 0.5227209609757253 + 0.0i, 0.231464095579871 + 0.07908586449328586i }, { 0.23146409557987097 + -0.07908586449328586i, 0.47727903902427465 + 0.0i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({false, false, true}), ElementsAreArray({ DoubleNear(0.5227209609757253, 1.0e-7), DoubleNear(0.47727903902427465, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({true, true, false}), Matrix({ { 0.3269796988924939 + 0.0i, 0.0 + 0.0i, 0.044298680503343096 + -0.0016468646540780275i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.044298680503343096 + 0.0016468646540780275i, 0.0 + 0.0i, 0.6730203011075061 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({true, true, false}), ElementsAreArray({ DoubleNear(0.3269796988924939, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.6730203011075061, 1.0e-7), DoubleNear(0.0, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({true, false, true}), Matrix({ { 0.5227209609757253 + 0.0i, 0.0 + 0.0i, 0.231464095579871 + 0.07908586449328586i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i }, { 0.23146409557987097 + -0.07908586449328586i, 0.0 + 0.0i, 0.47727903902427465 + 0.0i, 0.0 + 0.0i }, { 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i, 0.0 + 0.0i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({true, false, true}), ElementsAreArray({ DoubleNear(0.5227209609757253, 1.0e-7), DoubleNear(0.0, 1.0e-7), DoubleNear(0.47727903902427465, 1.0e-7), DoubleNear(0.0, 1.0e-7) }));

    EXPECT_EQ(s.getReducedDensityMatrix({false, true, true}), Matrix({ { 0.1709191424246377 + 0.0i, 0.023155848842664126 + -0.0008608506745766201i, 0.07568406027712965 + 0.025859472158667185i, 0.010383797732959171 + 0.0031222094058201266i }, { 0.023155848842664126 + 0.0008608506745766201i, 0.3518018185510876 + 0.0i, 0.010123310303216778 + 0.003884589481217386i, 0.15578003530274134 + 0.05322639233461868i }, { 0.07568406027712965 + -0.025859472158667185i, 0.01012331030321678 + -0.003884589481217386i, 0.15606055646785616 + 0.0i, 0.02114283166067897 + -0.0007860139795014074i }, { 0.010383797732959173 + -0.0031222094058201266i, 0.15578003530274132 + -0.05322639233461868i, 0.021142831660678967 + 0.0007860139795014074i, 0.3212184825564185 + 0.0i } }));

    EXPECT_THAT(s.getReducedDensityMatrixDiagonal({false, true, true}), ElementsAreArray({ DoubleNear(0.1709191424246377, 1.0e-7), DoubleNear(0.3518018185510876, 1.0e-7), DoubleNear(0.15606055646785616, 1.0e-7), DoubleNear(0.3212184825564185, 1.0e-7) }));


}
}

}
